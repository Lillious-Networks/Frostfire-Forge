<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/ico" href="./img/icons/favicon.ico">
    <link rel="stylesheet" href="./css/docs.css">
    <title>Frostfire Forge - API Documentation</title>
</head>
<body>
    <div class="home-button" onclick="location.href='/'"></div>
    <div class="container">
        <div class="header">
            <h1>Frostfire Forge</h1>
            <p>API Documentation - System Functions Reference</p>
            <div class="search-container">
                <input type="text" class="search-input" id="searchInput" placeholder="Search functions... (e.g., player.login, currency.add)" autocomplete="off">
                <span class="search-icon">🔍</span>
                <div class="search-results" id="searchResults"></div>
            </div>
        </div>
        
        <div class="system-section">
            <h2 class="system-title" id="system-audio">audio</h2>
            <div class="functions-container">
                
                    <div class="function-item clickable"
                         id="func-audio-get"
                         data-search="audio.get"
                         data-implementation="{
        const audioList = await audio.list();
        return audioList.find((a: any) =&gt; a.name === name);
    }"
                         data-function="audio.get"
                         data-async="true"
                         data-params="name: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">audio.<span class="method-name">get</span></span>
                            <span class="params">(<span style="color: #9cdcfe">name</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-audio-list"
                         data-search="audio.list"
                         data-implementation="{
        return await assetCache.get(&quot;audio&quot;) as AudioData[];
    }"
                         data-function="audio.list"
                         data-async="true"
                         data-params=""
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">audio.<span class="method-name">list</span></span>
                            <span class="params">()</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
            </div>
        </div>
    
        <div class="system-section">
            <h2 class="system-title" id="system-currency">currency</h2>
            <div class="functions-container">
                
                    <div class="function-item clickable"
                         id="func-currency-add"
                         data-search="currency.add"
                         data-implementation="{
        const currentCurrency = await this.get(username);
        if (!currentCurrency) return { copper: 0, silver: 0, gold: 0 };

        if (currentCurrency.copper + amount.copper &gt; max_copper) {
            const overflowToSilver = Math.floor((currentCurrency.copper + amount.copper) / (max_copper + 1));
            currentCurrency.silver += overflowToSilver;
            currentCurrency.copper = (currentCurrency.copper + amount.copper) % (max_copper + 1);
        }

        if (currentCurrency.silver + amount.silver &gt; max_silver) {
            const overflowToGold = Math.floor((currentCurrency.silver + amount.silver) / (max_silver + 1));
            currentCurrency.gold += overflowToGold;
            currentCurrency.silver = currentCurrency.silver % (max_silver + 1);
        }

        if (currentCurrency.gold + amount.gold &gt; max_gold) {
            currentCurrency.gold = max_gold;
        } else {
            currentCurrency.gold += amount.gold;
        }
        await this.set(username, currentCurrency);
        return currentCurrency;
    }"
                         data-function="currency.add"
                         data-async="true"
                         data-params="username: string, amount: Currency"
                         data-return="Currency">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">currency.<span class="method-name">add</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">amount</span>: <span style="color: #4ec9b0">Currency</span>)</span>
                            <span class="return-type">: Currency</span>
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-currency-get"
                         data-search="currency.get"
                         data-implementation="{
        if (!username) return { copper: 0, silver: 0, gold: 0 };
        const response = await query(&quot;SELECT copper, silver, gold FROM currency WHERE username = ?&quot;, [username]) as Currency[];
        if (response.length === 0) return { copper: 0, silver: 0, gold: 0 };
        return response[0] as Currency;
    }"
                         data-function="currency.get"
                         data-async="true"
                         data-params="username: string"
                         data-return="Currency">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">currency.<span class="method-name">get</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            <span class="return-type">: Currency</span>
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-currency-remove"
                         data-search="currency.remove"
                         data-implementation="{
        const currentCurrency = await this.get(username);
        if (!currentCurrency) return { copper: 0, silver: 0, gold: 0 };

        if (currentCurrency.copper &lt; amount.copper) {
            currentCurrency.copper = 0;
            currentCurrency.silver = Math.max(0, currentCurrency.silver - amount.silver);
            currentCurrency.gold = Math.max(0, currentCurrency.gold - amount.gold);
        } else {
            currentCurrency.copper -= amount.copper;
            if (currentCurrency.silver &lt; amount.silver) {
                currentCurrency.silver = 0;
                currentCurrency.gold = Math.max(0, currentCurrency.gold - amount.gold);
            } else {
                currentCurrency.silver -= amount.silver;
                if (currentCurrency.gold &lt; amount.gold) {
                    currentCurrency.gold = 0;
                } else {
                    currentCurrency.gold -= amount.gold;
                }
            }
        }
        await this.set(username, currentCurrency);
        return currentCurrency;
    }"
                         data-function="currency.remove"
                         data-async="true"
                         data-params="username: string, amount: Currency"
                         data-return="Currency">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">currency.<span class="method-name">remove</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">amount</span>: <span style="color: #4ec9b0">Currency</span>)</span>
                            <span class="return-type">: Currency</span>
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-currency-set"
                         data-search="currency.set"
                         data-implementation="{
        if (!username || !currencyData) return;
        const { copper, silver, gold } = currencyData;
        await query(
            &quot;INSERT INTO currency (username, copper, silver, gold) VALUES (?, ?, ?, ?) ON DUPLICATE KEY UPDATE copper = ?, silver = ?, gold = ?&quot;,
            [username, copper, silver, gold, copper, silver, gold]
        );
    }"
                         data-function="currency.set"
                         data-async="true"
                         data-params="username: string, currencyData: Currency"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">currency.<span class="method-name">set</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">currencyData</span>: <span style="color: #4ec9b0">Currency</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
            </div>
        </div>
    
        <div class="system-section">
            <h2 class="system-title" id="system-friends">friends</h2>
            <div class="functions-container">
                
                    <div class="function-item clickable"
                         id="func-friends-add"
                         data-search="friends.add"
                         data-implementation="{
    if (!username || !friend_username) return [];

    try {
      const queryResult = (await query(
        &quot;SELECT username FROM accounts WHERE username = ?&quot;,
        [friend_username]
      )) as any;
      console.log(&quot;Query Result:&quot;, queryResult);
      const user = queryResult[0]?.username;
      console.log(&quot;User:&quot;, user);
      if (!user) return await this.list(username);
      const currentFriends = await this.list(username);
      console.log(&quot;Current Friends:&quot;, currentFriends);

      if (currentFriends.includes(user.toString())) {
        return currentFriends; // Already a friend
      }

      currentFriends.push(user.toString());
      const friendsString = currentFriends.join(&quot;,&quot;);

      const result = (await query(
        &quot;INSERT INTO friendslist (username, friends) VALUES (?, ?) ON DUPLICATE KEY UPDATE friends = ?&quot;,
        [username, friendsString, friendsString]
      )) as any;

      console.log(result);

      if (result.affectedRows &gt; 0) {
        return currentFriends;
      } else {
        log.error(`Failed to add friend for ${username}`);
        return currentFriends;
      }
    } catch (error) {
      log.error(`Error adding friend for ${username}: ${error}`);
      return await this.list(username);
    }
  }"
                         data-function="friends.add"
                         data-async="true"
                         data-params="username: string, friend_username: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">friends.<span class="method-name">add</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">friend_username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-friends-list"
                         data-search="friends.list"
                         data-implementation="{
    if (!username) return [];
    try {
      const response = await query(
        &quot;SELECT friends FROM friendslist WHERE username = ?&quot;,
        [username]
      ) as any[];
      if (response.length === 0 || !response[0].friends) {
        return [];
      }
      const friendsList = response[0].friends
        .split(&quot;,&quot;)
        .map((friend: string) =&gt; friend.trim());
      return friendsList.filter((friend: any) =&gt; friend !== &quot;&quot;);
    } catch (error) {
      log.error(`Error listing friends for ${username}: ${error}`);
      return [];
    }
  }"
                         data-function="friends.list"
                         data-async="true"
                         data-params="username: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">friends.<span class="method-name">list</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-friends-remove"
                         data-search="friends.remove"
                         data-implementation="{
    console.log(&quot;Removing friend:&quot;, username, friend_username);
    if (!username || !friend_username) return [];

    try {
      // Check if the friend exists
      const queryResult = (await query(
        &quot;SELECT username FROM accounts WHERE username = ?&quot;,
        [friend_username]
      )) as any;

      const user = queryResult[0]?.username;
      if (!user) return [];

      // Get current friends list
      const currentFriends = await this.list(username);

      // Find and remove the friend
      const friendIndex = currentFriends.indexOf(friend_username.toString());
      if (friendIndex === -1) {
        return currentFriends; // Friend not found, return current list
      }

      currentFriends.splice(friendIndex, 1); // Remove friend
      const friendsString = currentFriends.join(&quot;,&quot;);

      // Update the database
      const result = (await query(
        &quot;UPDATE friendslist SET friends = ? WHERE username = ?&quot;,
        [friendsString, username]
      )) as any;

      console.log(&quot;Update result:&quot;, result);

      if (result.affectedRows &gt; 0) {
        return currentFriends; // Return updated friends list
      } else {
        log.error(`Failed to remove friend for ${username}`);
        return currentFriends;
      }
    } catch (error) {
      log.error(`Error removing friend for ${username}: ${error}`);
      return [];
    }
  }"
                         data-function="friends.remove"
                         data-async="true"
                         data-params="username: string, friend_username: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">friends.<span class="method-name">remove</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">friend_username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
            </div>
        </div>
    
        <div class="system-section">
            <h2 class="system-title" id="system-inventory">inventory</h2>
            <div class="functions-container">
                
                    <div class="function-item clickable"
                         id="func-inventory-add"
                         data-search="inventory.add"
                         data-implementation="{
    if (!name || !item?.quantity || !item?.name) return;
    if (Number(item.quantity) &lt;= 0) return;
    if (items.find((i) =&gt; i.name === item.name) === undefined)
      return;
    const response = (await inventory.find(name, item)) as InventoryItem[];

    if (response.length === 0)
      return await query(
        &quot;INSERT IGNORE INTO inventory (username, item, quantity) VALUES (?, ?, ?)&quot;,
        [name, item.name, Number(item.quantity)]
      );
    return await query(
      &quot;UPDATE inventory SET quantity = ? WHERE item = ? AND username = ?&quot;,
      [
        (Number(response[0].quantity) + Number(item.quantity)).toString(),
        item.name,
        name,
      ]
    );
  }"
                         data-function="inventory.add"
                         data-async="true"
                         data-params="name: string, item: InventoryItem"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">inventory.<span class="method-name">add</span></span>
                            <span class="params">(<span style="color: #9cdcfe">name</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">item</span>: <span style="color: #4ec9b0">InventoryItem</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-inventory-delete"
                         data-search="inventory.delete"
                         data-implementation="{
    if (!name || !item.name) return;
    return await query(
      &quot;DELETE FROM inventory WHERE item = ? AND username = ?&quot;,
      [item.name, name]
    );
  }"
                         data-function="inventory.delete"
                         data-async="true"
                         data-params="name: string, item: InventoryItem"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">inventory.<span class="method-name">delete</span></span>
                            <span class="params">(<span style="color: #9cdcfe">name</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">item</span>: <span style="color: #4ec9b0">InventoryItem</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-inventory-find"
                         data-search="inventory.find"
                         data-implementation="{
    if (!name || !item.name) return;
    return await query(
      &quot;SELECT * FROM inventory WHERE item = ? AND username = ?&quot;,
      [item.name, name]
    );
  }"
                         data-function="inventory.find"
                         data-async="true"
                         data-params="name: string, item: InventoryItem"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">inventory.<span class="method-name">find</span></span>
                            <span class="params">(<span style="color: #9cdcfe">name</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">item</span>: <span style="color: #4ec9b0">InventoryItem</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-inventory-get"
                         data-search="inventory.get"
                         data-implementation="{
    if (!name) return [];
    
    // Fetch items for the user
    const _items = await query(&quot;SELECT * FROM inventory WHERE username = ?&quot;, [name]) as any[];
    
    if (!_items || _items.length === 0) return []; // Return if no items found
  
    // Sanitize items by removing the username and id
    _items.filter((item: any) =&gt; {
      delete item.username;
      delete item.id;
    });
  
    // Fetch and process details for each item
    const details = await Promise.all(
      _items.map(async (item: any) =&gt; {
        // Fetch item details from cache
        const itemDetails = (items as any).find((i: any) =&gt; i.name === item.item);
        if (itemDetails) {
          return {
            ...item, // Inventory item details
            ...itemDetails, // Item details from cache
          };
        } else {
          // If item details are not found, return the item with blank details
          log.error(`Item details not found for: ${item.item}`);
          return {
            ...item,
            name: item.item,
            quality: &quot;unknown&quot;,
            description: &quot;unknown&quot;,
            icon: null,
          };
        }

      })
    );
    return details;
  }"
                         data-function="inventory.get"
                         data-async="true"
                         data-params="name: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">inventory.<span class="method-name">get</span></span>
                            <span class="params">(<span style="color: #9cdcfe">name</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-inventory-remove"
                         data-search="inventory.remove"
                         data-implementation="{
    if (!name || !item?.quantity || !item?.name) return;
    if (Number(item.quantity) &lt;= 0) return;
    if (items.find((i) =&gt; i.name === item.name) === undefined)
      return;
    const response = (await inventory.find(name, item)) as InventoryItem[];
    if (response.length === 0) return;
    if (Number(item.quantity) &gt;= Number(response[0].quantity))
      return await query(
        &quot;DELETE FROM inventory WHERE item = ? AND username = ?&quot;,
        [item.name, name]
      );
    return await query(
      &quot;UPDATE inventory SET quantity = ? WHERE item = ? AND username = ?&quot;,
      [
        (Number(response[0].quantity) - Number(item.quantity)).toString(),
        item.name,
        name,
      ]
    );
  }"
                         data-function="inventory.remove"
                         data-async="true"
                         data-params="name: string, item: InventoryItem"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">inventory.<span class="method-name">remove</span></span>
                            <span class="params">(<span style="color: #9cdcfe">name</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">item</span>: <span style="color: #4ec9b0">InventoryItem</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
            </div>
        </div>
    
        <div class="system-section">
            <h2 class="system-title" id="system-items">items</h2>
            <div class="functions-container">
                
                    <div class="function-item clickable"
                         id="func-items-add"
                         data-search="items.add"
                         data-implementation="{
    if (!item?.name || !item?.quality || !item?.description) return;
    return await query(
      &quot;INSERT IGNORE INTO items (name, quality, description, icon) VALUES (?, ?, ?, ?)&quot;,
      [item.name, item.quality, item.description, item.icon || null]
    );
  }"
                         data-function="items.add"
                         data-async="true"
                         data-params="item: Item"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">items.<span class="method-name">add</span></span>
                            <span class="params">(<span style="color: #9cdcfe">item</span>: <span style="color: #4ec9b0">Item</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-items-find"
                         data-search="items.find"
                         data-implementation="{
    if (!item?.name) return;
    const response = await query(&quot;SELECT * FROM items WHERE name = ?&quot;, [item.name]) as any;
    if (response.length === 0) return;
    return response;
  }"
                         data-function="items.find"
                         data-async="true"
                         data-params="item: Item"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">items.<span class="method-name">find</span></span>
                            <span class="params">(<span style="color: #9cdcfe">item</span>: <span style="color: #4ec9b0">Item</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-items-list"
                         data-search="items.list"
                         data-implementation="{
    return await query(&quot;SELECT * FROM items&quot;);
  }"
                         data-function="items.list"
                         data-async="true"
                         data-params=""
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">items.<span class="method-name">list</span></span>
                            <span class="params">()</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-items-remove"
                         data-search="items.remove"
                         data-implementation="{
    if (!item?.name) return;
    return await query(&quot;DELETE FROM items WHERE name = ?&quot;, [item.name]);
  }"
                         data-function="items.remove"
                         data-async="true"
                         data-params="item: Item"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">items.<span class="method-name">remove</span></span>
                            <span class="params">(<span style="color: #9cdcfe">item</span>: <span style="color: #4ec9b0">Item</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-items-update"
                         data-search="items.update"
                         data-implementation="{
    if (!item?.name || !item?.quality || !item?.description) return;
    const result = await query(
      &quot;UPDATE items SET quality = ?, description = ?, icon = ? WHERE name = ?&quot;,
      [item.quality, item.description, item.name, item.icon || null]
    );
    if (result) {
      const items = await assetCache.get(&quot;items&quot;) as Item[];
      const index = items.findIndex((i) =&gt; i.name === item.name);
      items[index] = item;
      assetCache.set(&quot;items&quot;, items);
    }
  }"
                         data-function="items.update"
                         data-async="true"
                         data-params="item: Item"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">items.<span class="method-name">update</span></span>
                            <span class="params">(<span style="color: #9cdcfe">item</span>: <span style="color: #4ec9b0">Item</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
            </div>
        </div>
    
        <div class="system-section">
            <h2 class="system-title" id="system-language">language</h2>
            <div class="functions-container">
                
                    <div class="function-item clickable"
                         id="func-language-translate"
                         data-search="language.translate"
                         data-implementation="{
        let response = text;
        if (!text || text.trim() === &quot;&quot;) return text;

        try {
            const translationPromise = (async () =&gt; {
                if (TRANSLATION_SERVICE.toLowerCase() === &quot;google_translate&quot;) {
                    if (!GOOGLE_TRANSLATE_API_KEY) {
                        log.warn(&quot;Google Translate API Key not found&quot;);
                        return response;
                    }
                    response = await language.translate_google({ text, lang }) as any;
                }

                if (TRANSLATION_SERVICE.toLowerCase() === &quot;openai&quot;) {
                    if (!OPENAI_API_KEY) {
                        log.warn(&quot;OpenAI API Key not found&quot;);
                        return response;
                    }
                    response = await language.translate_openai({ text, lang }) as any;
                }
                return response;
            })();

            // Set 3 second timeout
            const timeoutPromise = new Promise((_, reject) =&gt; {
                setTimeout(() =&gt; reject(new Error(&#039;Translation timeout&#039;)), 1000);
            });

            response = await Promise.race([translationPromise, timeoutPromise]) as string;
        } catch (error) {
            // Default to google translate if error
            log.error(`Error translating text: ${error}`);
            return language.translate_google({ text, lang }) as any;
        }

        // Replace any HTML entities
        const htmlEntities: { [key: string]: string } = {
            &quot;&amp;amp;&quot;: &quot;&amp;&quot;,
            &quot;&amp;lt;&quot;: &quot;&lt;&quot;,
            &quot;&amp;gt;&quot;: &quot;&gt;&quot;,
            &quot;&amp;quot;&quot;: &quot;\&quot;&quot;,
            &quot;&amp;#39;&quot;: &quot;&#039;&quot;,
            &quot;&amp;#96;&quot;: &quot;`&quot;
        };

        response = response.replace(/&amp;(?:amp|lt|gt|quot|#39|#96);/g, (match: string) =&gt; htmlEntities[match]);
        return response;
    }"
                         data-function="language.translate"
                         data-async="true"
                         data-params="text: string, lang: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">language.<span class="method-name">translate</span></span>
                            <span class="params">(<span style="color: #9cdcfe">text</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">lang</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-language-translate_google"
                         data-search="language.translate_google"
                         data-implementation="{
        log.debug(`Translating text: ${data.text} to ${data.lang} using Google Translate`);
        const url = new URL(&quot;https://translation.googleapis.com/language/translate/v2&quot;);
        // API Key
        url.searchParams.append(&#039;key&#039;, GOOGLE_TRANSLATE_API_KEY as string);
        // Text to translate
        url.searchParams.append(&#039;q&#039;, data.text);
        
        // Target language
        url.searchParams.append(&#039;target&#039;, data.lang);

        const response = await fetch(url, {
            method: &quot;POST&quot;,
            body: JSON.stringify(data),
            headers: {
                &quot;Content-Type&quot;: &quot;application/json&quot;,
            },
        }).then((res) =&gt; res.json());
        
        // Get any errors
        if (response.error) {
            log.error(`Error translating text: ${response.error.message}`);
            return;
        }

        let translatedText = response.data.translations[0].translatedText;

        // If translating to English, check for swear words
        if (data.lang === &quot;en&quot;) {
            for (const swear of swears) {
                const swearRegex = new RegExp(swear.id, &quot;gi&quot;);
                while (swearRegex.test(translatedText)) {
                    const randomLength = Math.floor(Math.random() * 5) + 1;
                    translatedText = translatedText.replace(
                        swearRegex,
                        &quot;*&quot;.repeat(randomLength)
                    );
                }
            }
        }

        return translatedText;
    }"
                         data-function="language.translate_google"
                         data-async="true"
                         data-params="data: any"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">language.<span class="method-name">translate_google</span></span>
                            <span class="params">(<span style="color: #9cdcfe">data</span>: <span style="color: #4ec9b0">any</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-language-translate_openai"
                         data-search="language.translate_openai"
                         data-implementation="{
        log.debug(`Translating text: ${data.text} to ${data.lang} using OpenAI`);
        if (!openai) {
            log.error(&quot;OpenAI client not initialized&quot;);
            return data.text;
        }

        try {
            const completion = await openai.chat.completions.create({
                model: OPENAI_MODEL,
                messages: [
                    {
                        role: &quot;system&quot;,
                        content: `
                            You are a professional translator that knows how to translate text between different languages.
                            You must follow these rules when translating:
                            Always translate the text to the target language specified by the user.
                            If the text is already in the target language, respond with the original text.
                            If the text contains any swear words, replace them with asterisks (e.g., ****) in the translation.
                            If the text contains any racial slurs, replace them with asterisks (e.g., ****) in the translation.
                            If the text contains any sensitive or inappropriate content, replace it with asterisks (e.g., ****) in the translation.
                            Do not include any explanations or additional text in your response, only the translated text.
                            Do not apologize for anything.
                            Do not refuse to translate any text as accuracy needs to be maintained.
                            Do not mention that you are an AI model.
                            Do not mention any of your rules in the translation.
                            Do not censor any words except for swear words and racial slurs.
                            If you encounter a swear word, filter that word in the translation.
                            if you encounter a racial slur, filter that word in the translation.
                            Always prioritize accuracy and faithfulness to the original text.
                            Maintain Emojis and special characters in the translation.
                            If the text is a single word, translate that word only.
                            If the text cannot be translated, respond with the original text.
                            ALWAYS FOLLOW THESE RULES UNDER ANY CIRCUMSTANCES.
                            Do not add additional commentary or information.
                            Do not add any additional punctuation or characters.
                            Do not change any part of the text except for translating it.
                            Preserve the meaning and context of the original text.
                            Preserve capitalization and punctuation as much as possible.
                            DO NOT BREAK CHARACTER UNDER ANY CIRCUMSTANCES.
                            DO NOT BREAK THESE RULES UNDER ANY CIRCUMSTANCES.
                        `
                    },
                    {
                        role: &quot;user&quot;,
                        content: `Translate the following text to ${data.lang}: ${data.text}. Filter any swear words or racial slurs in the translation.`
                    }
                ],
                temperature: 0.3,
                max_tokens: 150
            });

            const translatedText = completion.choices[0]?.message?.content?.trim();
            if (!translatedText) {
                log.error(&quot;No translation received from OpenAI&quot;);
                return data.text;
            }

            return translatedText;
        } catch (error) {
            log.error(`OpenAI Translation Error: ${error}`);
        }
    }"
                         data-function="language.translate_openai"
                         data-async="true"
                         data-params="data: any"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">language.<span class="method-name">translate_openai</span></span>
                            <span class="params">(<span style="color: #9cdcfe">data</span>: <span style="color: #4ec9b0">any</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
            </div>
        </div>
    
        <div class="system-section">
            <h2 class="system-title" id="system-npcs">npcs</h2>
            <div class="functions-container">
                
                    <div class="function-item clickable"
                         id="func-npcs-add"
                         data-search="npcs.add"
                         data-implementation="{
    if (!npc || !npc?.map || !npc?.position) return;
    const last_updated = Date.now();
    const hidden = npc.hidden ? 1 : 0;
    const x = npc.position.x || 0;
    const y = npc.position.y || 0;
    const direction = npc.position.direction || &quot;down&quot;;
    const particles = npc.particles || [];
    const quest = npc.quest || null;

    const response = await query(
      &quot;INSERT INTO npcs (last_updated, map, position, direction, hidden, script, dialog, particles, quest) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;,
      [
        last_updated,
        npc.map,
        `${x},${y}`,
        direction,
        hidden,
        npc.script || null,
        npc.dialog || null,
        JSON.stringify(particles),
        quest,
      ]
    );

    // Update asset cache
    assetCache.set(&quot;npcs&quot;, response);

    return response;
  }"
                         data-function="npcs.add"
                         data-async="true"
                         data-params="npc: Npc"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">npcs.<span class="method-name">add</span></span>
                            <span class="params">(<span style="color: #9cdcfe">npc</span>: <span style="color: #4ec9b0">Npc</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-npcs-find"
                         data-search="npcs.find"
                         data-implementation="{
    if (!npc?.id) return;
    const response = await query(&quot;SELECT * FROM npcs WHERE id = ?&quot;, [npc.id]);

    // Update asset cache
    assetCache.set(&quot;npcs&quot;, response);

    return response;
  }"
                         data-function="npcs.find"
                         data-async="true"
                         data-params="npc: Npc"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">npcs.<span class="method-name">find</span></span>
                            <span class="params">(<span style="color: #9cdcfe">npc</span>: <span style="color: #4ec9b0">Npc</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-npcs-list"
                         data-search="npcs.list"
                         data-implementation="{
    const response = (await query(&quot;SELECT * FROM npcs&quot;)) as any[];
    const npcs: Npc[] = [];
    
    for (const npc of response) {
      const map = npc?.map as string;
      const position: PositionData = {
        x: Number(npc?.position?.split(&quot;,&quot;)[0]),
        y: Number(npc?.position?.split(&quot;,&quot;)[1]),
        direction: npc?.direction || &quot;down&quot;,
      };

      npcs.push({
        id: npc?.id as number,
        last_updated: (npc?.last_updated as number) || null,
        map,
        position,
        hidden: npc?.hidden === 1,
        script: npc?.script as string,
        dialog: npc?.dialog as string,
        particles: npc?.particles as Particle[],
        quest: npc?.quest as number,
      });
    }

    return npcs;
  }"
                         data-function="npcs.list"
                         data-async="true"
                         data-params=""
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">npcs.<span class="method-name">list</span></span>
                            <span class="params">()</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-npcs-move"
                         data-search="npcs.move"
                         data-implementation="{
    if (!npc?.id || !npc?.position) return;
    const last_updated = Date.now();

    const response = await query(
      &quot;UPDATE npcs SET last_updated = ?, position = ? WHERE id = ?&quot;,
      [last_updated, JSON.stringify(npc.position), npc.id]
    );

    // Update asset cache
    assetCache.set(&quot;npcs&quot;, response);

    return response;
  }"
                         data-function="npcs.move"
                         data-async="true"
                         data-params="npc: Npc"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">npcs.<span class="method-name">move</span></span>
                            <span class="params">(<span style="color: #9cdcfe">npc</span>: <span style="color: #4ec9b0">Npc</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-npcs-remove"
                         data-search="npcs.remove"
                         data-implementation="{
    if (!npc?.id) return;
    const response = await query(&quot;DELETE FROM npcs WHERE id = ?&quot;, [npc.id]);

    // Update asset cache
    assetCache.set(&quot;npcs&quot;, response);

    return response;
  }"
                         data-function="npcs.remove"
                         data-async="true"
                         data-params="npc: Npc"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">npcs.<span class="method-name">remove</span></span>
                            <span class="params">(<span style="color: #9cdcfe">npc</span>: <span style="color: #4ec9b0">Npc</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-npcs-update"
                         data-search="npcs.update"
                         data-implementation="{
    if (!npc?.id || !npc?.map || !npc?.position) return;
    const last_updated = Date.now();
    const hidden = npc.hidden ? 1 : 0;
    const x = npc.position.x || 0;
    const y = npc.position.y || 0;
    const direction = npc.position.direction;
    const particles = npc.particles || [];
    const quest = npc.quest || null;

    const response = await query(
      &quot;UPDATE npcs SET last_updated = ?, map = ?, position = ?, direction = ?, hidden = ?, script = ?, dialog = ?, particles = ?, quest = ? WHERE id = ?&quot;,
      [
        last_updated,
        npc.map,
        `${x},${y}`,
        direction,
        hidden,
        npc.script,
        npc.dialog,
        JSON.stringify(particles),
        quest,
        npc.id,
      ]
    );

    // Update asset cache
    assetCache.set(&quot;npcs&quot;, response);

    return response;
  }"
                         data-function="npcs.update"
                         data-async="true"
                         data-params="npc: Npc"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">npcs.<span class="method-name">update</span></span>
                            <span class="params">(<span style="color: #9cdcfe">npc</span>: <span style="color: #4ec9b0">Npc</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
            </div>
        </div>
    
        <div class="system-section">
            <h2 class="system-title" id="system-particles">particles</h2>
            <div class="functions-container">
                
                    <div class="function-item clickable"
                         id="func-particles-add"
                         data-search="particles.add"
                         data-implementation="{
    const response = await query(&quot;INSERT INTO particles (size, color, velocity, lifetime, scale, opacity, visible, gravity, name, localposition, interval, amount, staggertime, spread, affected_by_weather) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;, [particle.size, particle.color, particle.velocity, particle.lifetime, particle.scale, particle.opacity, particle.visible, particle.gravity, particle.name, particle.localposition, particle.interval, particle.amount, particle.staggertime, particle.spread, particle.affected_by_weather]);
    await assetCache.set(&quot;particles&quot;, response);
    return response;
  }"
                         data-function="particles.add"
                         data-async="true"
                         data-params="particle: Particle"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">particles.<span class="method-name">add</span></span>
                            <span class="params">(<span style="color: #9cdcfe">particle</span>: <span style="color: #4ec9b0">Particle</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-particles-find"
                         data-search="particles.find"
                         data-implementation="{
    const response = await query(&quot;SELECT * FROM particles WHERE name = ?&quot;, [particle.name]) as any[];
    const weather = weathers.find((w) =&gt; w.name === world?.weather) || &#039;none&#039;;
    const p: Particle = {
      name: response[0]?.name,
      size: response[0]?.size,
      color: response[0]?.color,
      velocity: response[0]?.velocity,
      lifetime: response[0]?.lifetime,
      scale: response[0]?.scale,
      opacity: response[0]?.opacity,
      visible: response[0]?.visible,
      gravity: response[0]?.gravity,
      localposition: response[0]?.localposition,
      interval: response[0]?.interval,
      amount: response[0]?.amount,
      staggertime: response[0]?.staggertime,
      spread: response[0]?.spread,
      currentLife: null,
      initialVelocity: null,
      weather: response[0]?.affected_by_weather ? weather : &#039;none&#039;,
    };
    await assetCache.set(&quot;particles&quot;, p);
    return p;
  }"
                         data-function="particles.find"
                         data-async="true"
                         data-params="particle: Particle"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">particles.<span class="method-name">find</span></span>
                            <span class="params">(<span style="color: #9cdcfe">particle</span>: <span style="color: #4ec9b0">Particle</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-particles-list"
                         data-search="particles.list"
                         data-implementation="{
    const response = await query(&quot;SELECT * FROM particles&quot;) as any[];
    const particles: Particle[] = [];

    for (const particle of response) {
      const weather = weathers.find((w) =&gt; w.name === world?.weather) || &#039;none&#039;;
      const p: Particle = {
        name: particle.name,
        size: particle.size,
        color: particle.color,
        lifetime: particle.lifetime,
        scale: particle.scale,
        opacity: particle.opacity,
        visible: particle.visible,
        gravity: {
          x: Number(particle.gravity?.split(&quot;,&quot;)[0]) || 0,
          y: Number(particle.gravity?.split(&quot;,&quot;)[1]) || 0,
        },
        localposition: {
          x: Number(particle.localposition?.split(&quot;,&quot;)[0]) || 0,
          y: Number(particle.localposition?.split(&quot;,&quot;)[1]) || 0,
        },
        velocity: {
          x: Number(particle.velocity?.split(&quot;,&quot;)[0]) || 0,
          y: Number(particle.velocity?.split(&quot;,&quot;)[1]) || 0,
        },
        interval: particle.interval,
        amount: particle.amount,
        staggertime: particle.staggertime,
        spread: {
          x: Number(particle.spread?.split(&quot;,&quot;)[0]) || 0,
          y: Number(particle.spread?.split(&quot;,&quot;)[1]) || 0,
        },
        currentLife: null,
        initialVelocity: null,
        weather: particle.affected_by_weather ? weather : &#039;none&#039;
      };
      particles.push(p);
    }
    await assetCache.set(&quot;particles&quot;, particles);
    return particles;
  }"
                         data-function="particles.list"
                         data-async="true"
                         data-params=""
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">particles.<span class="method-name">list</span></span>
                            <span class="params">()</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-particles-remove"
                         data-search="particles.remove"
                         data-implementation="{
    const response = await query(&quot;DELETE FROM particles WHERE name = ?&quot;, [particle.name]);
    await assetCache.set(&quot;particles&quot;, response);
    return response;
  }"
                         data-function="particles.remove"
                         data-async="true"
                         data-params="particle: Particle"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">particles.<span class="method-name">remove</span></span>
                            <span class="params">(<span style="color: #9cdcfe">particle</span>: <span style="color: #4ec9b0">Particle</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-particles-update"
                         data-search="particles.update"
                         data-implementation="{
    const response = await query(&quot;UPDATE particles SET size = ?, color = ?, velocity = ?, lifetime = ?, scale = ?, opacity = ?, visible = ?, gravity = ?, name = ?, localposition = ?, interval = ?, amount = ?, staggertime = ?, spread = ?, affected_by_weather = ? WHERE name = ?&quot;, [particle.size, particle.color, particle.velocity, particle.lifetime, particle.scale, particle.opacity, particle.visible, particle.gravity, particle.name, particle.localposition, particle.interval, particle.amount, particle.staggertime, particle.spread, particle.affected_by_weather, particle.name]);
    await assetCache.set(&quot;particles&quot;, response);
    return response;
  }"
                         data-function="particles.update"
                         data-async="true"
                         data-params="particle: Particle"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">particles.<span class="method-name">update</span></span>
                            <span class="params">(<span style="color: #9cdcfe">particle</span>: <span style="color: #4ec9b0">Particle</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
            </div>
        </div>
    
        <div class="system-section">
            <h2 class="system-title" id="system-parties">parties</h2>
            <div class="functions-container">
                
                    <div class="function-item clickable"
                         id="func-parties-add"
                         data-search="parties.add"
                         data-implementation="{
        if (!username) return [];
        try {
            // Check if the user is already in a party
            const existingParty = await this.exists(username);
            if (existingParty) return [];

            // Get party members
            const members = await this.getPartyMembers(partyId) as string[];
            if (!members || members?.length === 0) return [];

            // Check if party members exceed the limit of 5
            if (members.length &gt;= 5) return [];

            // Prevent adding the same user multiple times
            if (members.includes(username)) return [];

            // Add the user to the party
            await query(&quot;UPDATE accounts SET party_id = ? WHERE username = ?&quot;, [partyId, username]);
            const updatedMembers = [...members, username].join(&quot;, &quot;);
            await query(&quot;UPDATE parties SET members = ? WHERE id = ?&quot;, [updatedMembers, partyId]);
            return updatedMembers.split(&quot;, &quot;).map((member: string) =&gt; member.trim());
        } catch (error) {
            log.error(`Error adding user to party: ${error}`);
            return [];
        }
    }"
                         data-function="parties.add"
                         data-async="true"
                         data-params="username: string, partyId: number"
                         data-return="string[]">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">parties.<span class="method-name">add</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">partyId</span>: <span style="color: #4ec9b0">number</span>)</span>
                            <span class="return-type">: string[]</span>
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-parties-create"
                         data-search="parties.create"
                         data-implementation="{
        if (!leader || !username) return false;
        try {
            const existingParty = await this.exists(leader);
            if (existingParty) return false; // Leader is already in a party

            const members = [leader, username].join(&quot;, &quot;);
            const result = await query(&quot;INSERT INTO parties (leader, members) VALUES (?, ?)&quot;, [leader, members]) as any;
            const partyId = result.lastInsertRowid;

            // Update the accounts table to set the party_id for both users
            await query(&quot;UPDATE accounts SET party_id = ? WHERE username IN (?, ?)&quot;, [partyId, leader, username]);
            return members.split(&quot;, &quot;).map((member: string) =&gt; member.trim());
        } catch (error) {
            log.error(`Error creating party: ${error}`);
            return false;
        }
    }"
                         data-function="parties.create"
                         data-async="true"
                         data-params="leader: string, username: string"
                         data-return="string[] | boolean">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">parties.<span class="method-name">create</span></span>
                            <span class="params">(<span style="color: #9cdcfe">leader</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            <span class="return-type">: string[] | boolean</span>
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-parties-delete"
                         data-search="parties.delete"
                         data-implementation="{
        if (!partyId) return false;
        try {
            await query(&quot;DELETE FROM parties WHERE id = ?&quot;, [partyId]);
            // Remove party_id from all members in the accounts table
            await query(&quot;UPDATE accounts SET party_id = NULL WHERE party_id = ?&quot;, [partyId]);
            log.info(`Party with ID ${partyId} deleted successfully.`);
            return true;
        } catch (error) {
            log.error(`Error deleting party: ${error}`);
            return false;
        }
    }"
                         data-function="parties.delete"
                         data-async="true"
                         data-params="partyId: number"
                         data-return="boolean">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">parties.<span class="method-name">delete</span></span>
                            <span class="params">(<span style="color: #9cdcfe">partyId</span>: <span style="color: #4ec9b0">number</span>)</span>
                            <span class="return-type">: boolean</span>
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-parties-disband"
                         data-search="parties.disband"
                         data-implementation="{
        if (!username) return false;
        try {
            const partyId = await this.getPartyId(username);
            if (!partyId) return false; // User is not in a party

            const isLeader = await this.isPartyLeader(username);
            if (!isLeader) return false; // User is not the leader and cannot disband

            const members = await this.getPartyMembers(partyId);
            if (members.length === 0) return false; // No members to disband

            // Remove all members from the party
            await query(&quot;UPDATE accounts SET party_id = NULL WHERE party_id = ?&quot;, [partyId]);
            // Delete the party
            return await this.delete(partyId);
        } catch (error) {
            log.error(`Error disbanding party: ${error}`);
            return false;
        }
    }"
                         data-function="parties.disband"
                         data-async="true"
                         data-params="username: string"
                         data-return="boolean">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">parties.<span class="method-name">disband</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            <span class="return-type">: boolean</span>
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-parties-exists"
                         data-search="parties.exists"
                         data-implementation="{
        if (!username) return false;
        const result = await this.getPartyId(username);
        return result !== null;
    }"
                         data-function="parties.exists"
                         data-async="true"
                         data-params="username: string"
                         data-return="boolean">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">parties.<span class="method-name">exists</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            <span class="return-type">: boolean</span>
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-parties-getPartyId"
                         data-search="parties.getPartyId"
                         data-implementation="{
        if (!username) return null;
        try {
            const result = await query(&quot;SELECT party_id FROM accounts WHERE username = ?&quot;, [username]) as any[];
            if (result.length === 0 || !result[0].party_id) return null;
            return result[0].party_id;
        } catch (error) {
            log.error(`Error getting party ID for user: ${error}`);
            return null;
        }
    }"
                         data-function="parties.getPartyId"
                         data-async="true"
                         data-params="username: string"
                         data-return="number | null">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">parties.<span class="method-name">getPartyId</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            <span class="return-type">: number | null</span>
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-parties-getPartyLeader"
                         data-search="parties.getPartyLeader"
                         data-implementation="{
        if (!partyId) return null;
        try {
            const result = await query(&quot;SELECT leader FROM parties WHERE id = ?&quot;, [partyId]) as any[];
            if (result.length === 0 || !result[0].leader) return null; // Party not found or no leader
            return result[0].leader;
        } catch (error) {
            log.error(`Error getting party leader: ${error}`);
            return null;
        }
    }"
                         data-function="parties.getPartyLeader"
                         data-async="true"
                         data-params="partyId: number"
                         data-return="string | null">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">parties.<span class="method-name">getPartyLeader</span></span>
                            <span class="params">(<span style="color: #9cdcfe">partyId</span>: <span style="color: #4ec9b0">number</span>)</span>
                            <span class="return-type">: string | null</span>
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-parties-getPartyMembers"
                         data-search="parties.getPartyMembers"
                         data-implementation="{
        if (!partyId) return [];
        try {
            const result = await query(&quot;SELECT members FROM parties WHERE id = ?&quot;, [partyId]) as any[];
            if (result.length === 0 || !result[0].members) return []; // Party not found or no members
            const members = result[0].members.split(&quot;,&quot;).map((member: any) =&gt; member.trim());
            return members.filter((member: any) =&gt; member);
        } catch (error) {
            log.error(`Error getting party members: ${error}`);
            return [];
        }
    }"
                         data-function="parties.getPartyMembers"
                         data-async="true"
                         data-params="partyId: number"
                         data-return="string[]">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">parties.<span class="method-name">getPartyMembers</span></span>
                            <span class="params">(<span style="color: #9cdcfe">partyId</span>: <span style="color: #4ec9b0">number</span>)</span>
                            <span class="return-type">: string[]</span>
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-parties-isInParty"
                         data-search="parties.isInParty"
                         data-implementation="{
        if (!username) return false;
        try {
            const result = await query(&quot;SELECT party_id FROM accounts WHERE username = ?&quot;, [username]) as any[];
            if (result.length === 0) return false; // User not found
            return result.length &gt; 0;
        } catch (error) {
            log.error(`Error checking if user is in party: ${error}`);
            return false;
        }
    }"
                         data-function="parties.isInParty"
                         data-async="true"
                         data-params="username: string"
                         data-return="boolean">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">parties.<span class="method-name">isInParty</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            <span class="return-type">: boolean</span>
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-parties-isPartyLeader"
                         data-search="parties.isPartyLeader"
                         data-implementation="{
        if (!username) return false;
        try {
            const result = await query(&quot;SELECT id FROM parties WHERE leader = ?&quot;, [username]) as any[];
            return result.length &gt; 0;
        } catch (error) {
            log.error(`Error checking if user is party leader: ${error}`);
            return false;
        }
    }"
                         data-function="parties.isPartyLeader"
                         data-async="true"
                         data-params="username: string"
                         data-return="boolean">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">parties.<span class="method-name">isPartyLeader</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            <span class="return-type">: boolean</span>
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-parties-leave"
                         data-search="parties.leave"
                         data-implementation="{
        if (!username) return false;
        try {
            const partyId = await this.getPartyId(username);
            if (!partyId) return false; // User is not in a party

            const isLeader = await this.isPartyLeader(username);
            if (isLeader) return await this.delete(partyId);

            return await this.remove(username);
        } catch (error) {
            log.error(`Error leaving party: ${error}`);
            return false;
        }
    }"
                         data-function="parties.leave"
                         data-async="true"
                         data-params="username: string"
                         data-return="boolean | string[]">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">parties.<span class="method-name">leave</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            <span class="return-type">: boolean | string[]</span>
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-parties-remove"
                         data-search="parties.remove"
                         data-implementation="{
        if (!username) return [];
        try {
            const partyId = await this.getPartyId(username);
            if (!partyId) return []; // User is not in a party

            await query(&quot;UPDATE accounts SET party_id = NULL WHERE username = ?&quot;, [username]);

            const members = await this.getPartyMembers(partyId);

            // Remove the user from the members list
            const updatedMembers = members.filter((member: string) =&gt; member !== username).join(&quot;, &quot;);
            await query(&quot;UPDATE parties SET members = ? WHERE id = ?&quot;, [updatedMembers, partyId]);

            // If the party has no members left, delete the party
            const memberArray = Array.isArray(updatedMembers) ? updatedMembers.split(&quot;, &quot;) : [updatedMembers];
            if (memberArray.length &lt;= 1) {
                await this.delete(partyId);
                return true; // Party deleted
            }

            return memberArray.map((member: string) =&gt; member.trim());
        } catch (error) {
            log.error(`Error removing user from party: ${error}`);
            return [];
        }
    }"
                         data-function="parties.remove"
                         data-async="true"
                         data-params="username: string"
                         data-return="string[] | boolean">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">parties.<span class="method-name">remove</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            <span class="return-type">: string[] | boolean</span>
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
            </div>
        </div>
    
        <div class="system-section">
            <h2 class="system-title" id="system-permissions">permissions</h2>
            <div class="functions-container">
                
                    <div class="function-item clickable"
                         id="func-permissions-add"
                         data-search="permissions.add"
                         data-implementation="{
        // Get permissions for a player
        const response = await permissions.get(username) as string;
        const access = response.includes(&quot;,&quot;) ? response.split(&quot;,&quot;) : response.length ? [response] : [];
        if (access.includes(permission)) return;
        access.push(permission);
        await permissions.set(username, access);
        log.info(`Permission ${permission} added to ${username}`);
    }"
                         data-function="permissions.add"
                         data-async="true"
                         data-params="username: string, permission: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">permissions.<span class="method-name">add</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">permission</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-permissions-clear"
                         data-search="permissions.clear"
                         data-implementation="{
        // Clear permissions for a player
        await query(&quot;UPDATE permissions SET permissions = NULL WHERE username = ?&quot;, [username]);
        log.info(`Permissions cleared for ${username}`);
    }"
                         data-function="permissions.clear"
                         data-async="true"
                         data-params="username: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">permissions.<span class="method-name">clear</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-permissions-get"
                         data-search="permissions.get"
                         data-implementation="{
        // Get permissions for a player
        const response = await query(&quot;SELECT permissions FROM permissions WHERE username = ?&quot;, [username]) as { permissions: string }[];
        if (response.length === 0) return [];
        return response[0]?.permissions || [];
    }"
                         data-function="permissions.get"
                         data-async="true"
                         data-params="username: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">permissions.<span class="method-name">get</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-permissions-remove"
                         data-search="permissions.remove"
                         data-implementation="{
        // Get permissions for a player
        const response = await permissions.get(username) as string;
        const access = response.includes(&quot;,&quot;) ? response.split(&quot;,&quot;) : response.length ? [response] : [];
        if (!access.includes(permission)) return;
        access.splice(access.indexOf(permission), 1);
        await permissions.set(username, access);
        log.info(`Permission ${permission} removed from ${username}`);
    }"
                         data-function="permissions.remove"
                         data-async="true"
                         data-params="username: string, permission: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">permissions.<span class="method-name">remove</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">permission</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-permissions-set"
                         data-search="permissions.set"
                         data-implementation="{
        // Set permissions for a player
        const perms = typeof permissions === &quot;string&quot; ? [permissions] : permissions;
        // Remove duplicates
        const uniquePerms = Array.from(new Set(perms));
        await query(
            &quot;INSERT INTO permissions (username, permissions) VALUES (?, ?) ON DUPLICATE KEY UPDATE permissions = ?&quot;,
            [username, uniquePerms.join(&quot;,&quot;), uniquePerms.join(&quot;,&quot;)]
        );
        log.info(`Permissions ${uniquePerms.join(&quot;,&quot;)} set for ${username}`);
    }"
                         data-function="permissions.set"
                         data-async="true"
                         data-params="username: string, permissions: string | string[]"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">permissions.<span class="method-name">set</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">permissions</span>: <span style="color: #4ec9b0">string | string[]</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
            </div>
        </div>
    
        <div class="system-section">
            <h2 class="system-title" id="system-player">player</h2>
            <div class="functions-container">
                
                    <div class="function-item clickable"
                         id="func-player-ban"
                         data-search="player.ban"
                         data-implementation="{
    if (!username) return;
    username = username.toLowerCase();
    const response = await query(
      &quot;UPDATE accounts SET banned = 1 WHERE username = ?&quot;,
      [username]
    );
    const session_id = (await player.getSession(username)) as any;
    if (session_id[0]?.session_id) {
      player.logout(session_id[0]?.session_id);
    }
    if (ws) ws.close();
    return response;
  }"
                         data-function="player.ban"
                         data-async="true"
                         data-params="username: string, ws: WebSocket"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">ban</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">ws</span>: <span style="color: #4ec9b0">WebSocket</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-canAttack"
                         data-search="player.canAttack"
                         data-implementation="{ value: boolean; reason?: string }"
                         data-function="player.canAttack"
                         data-async="false"
                         data-params="self: Player, target: Player, playerProperties: PlayerProperties"
                         data-return="">
                        <div class="function-signature">
                            
                            <span class="function-name">player.<span class="method-name">canAttack</span></span>
                            <span class="params">(<span style="color: #9cdcfe">self</span>: <span style="color: #4ec9b0">Player</span>, <span style="color: #9cdcfe">target</span>: <span style="color: #4ec9b0">Player</span>, <span style="color: #9cdcfe">playerProperties</span>: <span style="color: #4ec9b0">PlayerProperties</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-checkIfWouldCollide"
                         data-search="player.checkIfWouldCollide"
                         data-implementation="{
    const playerWidth = playerProperties.width || 32;
    const playerHeight = playerProperties.height || 32;
    const mapKey = map.replace(&quot;.json&quot;, &quot;&quot;);

    // Load map from cache or Redis
    let mapDataCached = mapCache.get(mapKey);
    if (!mapDataCached) {
      // Use provided cache or fall back to Redis
      const mapProperties = mapPropertiesCache || (await assetCache.get(&quot;mapProperties&quot;)) as MapProperties[];
      const mapData = mapProperties.find((m: any) =&gt; m.name.replace(&quot;.json&quot;, &quot;&quot;) === mapKey);
      if (!mapData) return { value: true, reason: &quot;no_map_data&quot; };

      let collisionData: any;
      try {
        const fetched = await assetCache.getNested(mapKey, &quot;collision&quot;);
        collisionData = fetched !== undefined ? fetched : (await assetCache.get(mapKey))?.collision;
        if (!collisionData || !Array.isArray(collisionData)) return { value: true, reason: &quot;no_collision_data&quot; };
      } catch (err: any) {
        console.error(`[RedisDebug] Failed to fetch collision for ${mapKey}:`, err);
        return { value: true, reason: &quot;redis_error&quot; };
      }

      // Decode RLE once
      const data = collisionData.slice(2);
      const grid = new Uint8Array(mapData.width * mapData.height);
      let currentIndex = 0;
      for (let i = 0; i &lt; data.length; i += 2) {
        const value = data[i];
        const count = data[i + 1];
        for (let j = 0; j &lt; count; j++) grid[currentIndex++] = value;
      }

      mapDataCached = {
        warps: Array.isArray(mapData.warps)
          ? Object.fromEntries(
              (mapData.warps as WarpObject[]).map((warp, idx) =&gt; [warp.name ?? String(idx), warp])
            )
          : (mapData.warps || {}),
        grid,
        width: mapData.width,
        height: mapData.height,
        tileWidth: mapData.tileWidth,
        tileHeight: mapData.tileHeight,
      };

      mapCache.set(mapKey, mapDataCached);
    }

    const { warps, grid, width, height, tileWidth, tileHeight } = mapDataCached;

    // Add offsets to align player coordinates with the collision grid
    const gridOffsetWidth = Math.floor(width / 2);
    const gridOffsetHeight = Math.floor(height / 2);

    // Warp collision
    for (const key in warps) {
      const warp = warps[key];
      if (
        position.x + playerWidth &gt; warp.position.x &amp;&amp;
        position.x &lt; warp.position.x + warp.size.width &amp;&amp;
        position.y + playerHeight &gt; warp.position.y &amp;&amp;
        position.y &lt; warp.position.y + warp.size.height
      ) {
        return {
          value: true,
          reason: &quot;warp_collision&quot;,
          warp: { map: warp.map, position: { x: warp.x, y: warp.y } },
        };
      }
    }

    // Tile collision
    const margin = 0.1;
    const left = Math.floor(((position.x + margin) / tileWidth) + 0.6);
    const right = Math.floor(((position.x + playerWidth - margin) / tileWidth) + 0.6);
    const top = Math.floor(((position.y + margin) / tileHeight) + 1.5);
    const bottom = Math.floor((position.y + playerHeight - margin) / tileHeight + 0.7);

    for (let y = top; y &lt;= bottom; y++) {
      for (let x = left; x &lt;= right; x++) {
        const tileX = x + gridOffsetWidth;
        const tileY = y + gridOffsetHeight;

        if (tileX &lt; 0 || tileY &lt; 0 || tileX &gt;= width || tileY &gt;= height) continue;

        const tileValue = grid[tileY * width + tileX];
        if (tileValue !== 0) return { value: true, reason: &quot;tile_collision&quot;, tile: { x, y } };
      }
    }

    return { value: false, reason: &quot;no_collision&quot; };
  }"
                         data-function="player.checkIfWouldCollide"
                         data-async="true"
                         data-params="map: string, position: PositionData, playerProperties: PlayerProperties, mapPropertiesCache?: any"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">checkIfWouldCollide</span></span>
                            <span class="params">(<span style="color: #9cdcfe">map</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">position</span>: <span style="color: #4ec9b0">PositionData</span>, <span style="color: #9cdcfe">playerProperties</span>: <span style="color: #4ec9b0">PlayerProperties</span>, <span style="color: #9cdcfe">mapPropertiesCache?</span>: <span style="color: #4ec9b0">any</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-clear"
                         data-search="player.clear"
                         data-implementation="{
    // Clear all session_ids, set online to 0, and clear all tokens
    await query(
      &quot;UPDATE accounts SET session_id = NULL, online = 0, token = NULL, verified = 0, verification_code = NULL, party_id = NULL&quot;
    );
    // Truncate the parties table
    if (process.env.DATABASE_ENGINE === &quot;sqlite&quot;) {
      await query(&quot;DELETE FROM parties&quot;);
    } else {
      await query(&quot;TRUNCATE TABLE parties&quot;);
    }

    // Clear all guest accounts
    await query(&quot;DELETE FROM accounts WHERE guest_mode = 1&quot;);
    // Clear stats of guest accounts
    await query(&quot;DELETE FROM stats WHERE username IN (SELECT username FROM accounts WHERE guest_mode = 1)&quot;);
    // Clear client configs of guest accounts
    await query(&quot;DELETE FROM clientconfig WHERE username IN (SELECT username FROM accounts WHERE guest_mode = 1)&quot;);
    // Clear quest logs of guest accounts
    await query(&quot;DELETE FROM quest_log WHERE username IN (SELECT username FROM accounts WHERE guest_mode = 1)&quot;);
    // Clear currency of guest accounts
    await query(&quot;DELETE FROM currency WHERE username IN (SELECT username FROM accounts WHERE guest_mode = 1)&quot;);
  }"
                         data-function="player.clear"
                         data-async="true"
                         data-params=""
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">clear</span></span>
                            <span class="params">()</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-clearSessionId"
                         data-search="player.clearSessionId"
                         data-implementation="{
    if (!session_id) return;
    const response = await query(
      &quot;UPDATE accounts SET session_id = NULL, online = ? WHERE session_id = ?&quot;,
      [0, session_id]
    );
    return response;
  }"
                         data-function="player.clearSessionId"
                         data-async="true"
                         data-params="session_id: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">clearSessionId</span></span>
                            <span class="params">(<span style="color: #9cdcfe">session_id</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-findByEmail"
                         data-search="player.findByEmail"
                         data-implementation="{
    if (!email) return;
    const response = await query(&quot;SELECT email FROM accounts WHERE email = ?&quot;, [
      email,
    ]);
    return response;
  }"
                         data-function="player.findByEmail"
                         data-async="true"
                         data-params="email: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">findByEmail</span></span>
                            <span class="params">(<span style="color: #9cdcfe">email</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-findByUsername"
                         data-search="player.findByUsername"
                         data-implementation="{
    if (!username) return;
    username = username.toLowerCase();
    const response = await query(
      &quot;SELECT username FROM accounts WHERE username = ?&quot;,
      [username]
    );
    return response || [];
  }"
                         data-function="player.findByUsername"
                         data-async="true"
                         data-params="username: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">findByUsername</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-findClosestPlayer"
                         data-search="player.findClosestPlayer"
                         data-implementation="{
    if (!players) return null;
    if (!self.location?.position) return null;

    let closestPlayer = null;
    let closestDistance = range;
    const selfPosition = self.location.position as unknown as PositionData;
    for (const player of players) {
      if (player.location) {
        const position = player.location.position as unknown as PositionData;
        const distance = Math.sqrt(
          Math.pow(selfPosition.x - position.x, 2) +
            Math.pow(selfPosition.y - position.y, 2)
        );
        if (player.isStealth) continue;
        if (distance &lt; closestDistance) {
          closestDistance = distance;
          closestPlayer = player;
        }
      }
    }
    return closestPlayer;
  }"
                         data-function="player.findClosestPlayer"
                         data-async="false"
                         data-params="self: Player, players: Player[], range: number"
                         data-return="NullablePlayer">
                        <div class="function-signature">
                            
                            <span class="function-name">player.<span class="method-name">findClosestPlayer</span></span>
                            <span class="params">(<span style="color: #9cdcfe">self</span>: <span style="color: #4ec9b0">Player</span>, <span style="color: #9cdcfe">players</span>: <span style="color: #4ec9b0">Player[]</span>, <span style="color: #9cdcfe">range</span>: <span style="color: #4ec9b0">number</span>)</span>
                            <span class="return-type">: NullablePlayer</span>
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-findPlayerInDatabase"
                         data-search="player.findPlayerInDatabase"
                         data-implementation="{
    if (!username &amp;&amp; !id) return;
    if (username) username = username.toLowerCase();
    const response = await query(
      &quot;SELECT username, banned FROM accounts WHERE username = ? OR session_id = ?&quot;,
      [username, id]
    );
    return response || [];
  }"
                         data-function="player.findPlayerInDatabase"
                         data-async="true"
                         data-params="username?: string, id?: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">findPlayerInDatabase</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username?</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">id?</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-getConfig"
                         data-search="player.getConfig"
                         data-implementation="{
    if (!username) return;
    username = username.toLowerCase();
    const response = await query(
      &quot;SELECT * FROM clientconfig WHERE username = ?&quot;,
      [username]
    );
    return response || [];
  }"
                         data-function="player.getConfig"
                         data-async="true"
                         data-params="username: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">getConfig</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-getEmail"
                         data-search="player.getEmail"
                         data-implementation="{
    if (!username) return;
    username = username.toLowerCase();
    const response = (await query(
      &quot;SELECT email FROM accounts WHERE username = ?&quot;,
      [username]
    )) as any;
    return response[0]?.email;
  }"
                         data-function="player.getEmail"
                         data-async="true"
                         data-params="username: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">getEmail</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-getLocation"
                         data-search="player.getLocation"
                         data-implementation="{
    const username = player.username || player.id;
    const response = (await query(
      &quot;SELECT map, position, direction FROM accounts WHERE username = ? OR session_id = ?&quot;,
      [username, username]
    )) as LocationData[];
    const map = response[0]?.map as string;
    const position: PositionData = {
      x: Number(response[0]?.position?.split(&quot;,&quot;)[0]),
      y: Number(response[0]?.position?.split(&quot;,&quot;)[1]),
      direction: response[0]?.direction || &quot;down&quot;,
    };

    if (
      !map ||
      (!position.x &amp;&amp; position.x.toString() != &quot;0&quot;) ||
      (!position.y &amp;&amp; position.y.toString() != &quot;0&quot;)
    ) {
      return null;
    }

    return { map, position };
  }"
                         data-function="player.getLocation"
                         data-async="true"
                         data-params="player: Player"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">getLocation</span></span>
                            <span class="params">(<span style="color: #9cdcfe">player</span>: <span style="color: #4ec9b0">Player</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-getMap"
                         data-search="player.getMap"
                         data-implementation="{
    if (!session_id) return;
    const response = (await query(
      &quot;SELECT map FROM accounts WHERE session_id = ?&quot;,
      [session_id]
    )) as any;
    return response[0]?.map as string;
  }"
                         data-function="player.getMap"
                         data-async="true"
                         data-params="session_id: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">getMap</span></span>
                            <span class="params">(<span style="color: #9cdcfe">session_id</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-getNewMaxXp"
                         data-search="player.getNewMaxXp"
                         data-implementation="{
    return Math.floor(100 * Math.pow(1.1, level - 1));
  }"
                         data-function="player.getNewMaxXp"
                         data-async="false"
                         data-params="level: number"
                         data-return="">
                        <div class="function-signature">
                            
                            <span class="function-name">player.<span class="method-name">getNewMaxXp</span></span>
                            <span class="params">(<span style="color: #9cdcfe">level</span>: <span style="color: #4ec9b0">number</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-getPartyIdByUsername"
                         data-search="player.getPartyIdByUsername"
                         data-implementation="{
    if (!username) return;
    username = username.toLowerCase();
    const response = (await query(
      &quot;SELECT party_id FROM accounts WHERE username = ?&quot;,
      [username]
    )) as any;
    return response[0]?.party_id;
  }"
                         data-function="player.getPartyIdByUsername"
                         data-async="true"
                         data-params="username: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">getPartyIdByUsername</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-GetPlayerLoginData"
                         data-search="player.GetPlayerLoginData"
                         data-implementation="{
    if (!username) return null;
    username = username.toLowerCase();

    // Single optimized query to get all player data using JOINs
    const mainQuery = `
      SELECT
        a.id,
        a.username,
        a.map,
        a.position,
        a.direction,
        a.role,
        a.guest_mode,
        a.stealth,
        a.noclip,
        a.party_id,
        p.permissions,
        s.max_health,
        s.health,
        s.max_stamina,
        s.stamina,
        s.xp,
        s.max_xp,
        s.level,
        c.copper,
        c.silver,
        c.gold,
        f.friends,
        cc.fps,
        cc.music_volume,
        cc.effects_volume,
        cc.muted,
        ql.completed_quests,
        ql.incomplete_quests
      FROM accounts a
      LEFT JOIN permissions p ON a.username = p.username
      LEFT JOIN stats s ON a.username = s.username
      LEFT JOIN currency c ON a.username = c.username
      LEFT JOIN friendslist f ON a.username = f.username
      LEFT JOIN clientconfig cc ON a.username = cc.username
      LEFT JOIN quest_log ql ON a.username = ql.username
      WHERE a.username = ?
    `;

    const result = await query(mainQuery, [username]) as any[];
    if (!result || result.length === 0) return null;

    const data = result[0];

    // Get inventory separately since it&#039;s an array of items
    const inventoryRaw = await query(&quot;SELECT * FROM inventory WHERE username = ?&quot;, [username]) as any[];

    return {
      id: data.id,
      username: data.username,
      location: {
        map: data.map,
        position: {
          x: Number(data.position?.split(&quot;,&quot;)[0] || 0),
          y: Number(data.position?.split(&quot;,&quot;)[1] || 0),
          direction: data.direction || &quot;down&quot;
        }
      },
      permissions: data.permissions || [],
      stats: {
        max_health: data.max_health,
        health: data.health,
        max_stamina: data.max_stamina,
        stamina: data.stamina,
        xp: data.xp,
        max_xp: data.max_xp,
        level: data.level
      },
      currency: {
        copper: data.copper || 0,
        silver: data.silver || 0,
        gold: data.gold || 0
      },
      friends: data.friends ? data.friends.split(&quot;,&quot;).map((f: string) =&gt; f.trim()).filter((f: string) =&gt; f !== &quot;&quot;) : [],
      party_id: data.party_id,
      config: data.fps ? [{
        fps: data.fps,
        music_volume: data.music_volume,
        effects_volume: data.effects_volume,
        muted: data.muted
      }] : [],
      questlog: {
        completed: data.completed_quests ? data.completed_quests.split(&quot;,&quot;) : [],
        incomplete: data.incomplete_quests ? data.incomplete_quests.split(&quot;,&quot;) : []
      },
      isAdmin: data.role === 1,
      isGuest: data.guest_mode === 1,
      isStealth: data.stealth === 1,
      isNoclip: data.noclip === 1,
      inventoryRaw: inventoryRaw
    };
  },
};

export default player;
"
                         data-function="player.GetPlayerLoginData"
                         data-async="true"
                         data-params="username: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">GetPlayerLoginData</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-getPlayers"
                         data-search="player.getPlayers"
                         data-implementation="{
    if (!map) return;
    const response = await query(
      &quot;SELECT username, session_id as id, position, map FROM accounts WHERE online = 1 and map = ?&quot;,
      [map]
    );
    return response;
  }"
                         data-function="player.getPlayers"
                         data-async="true"
                         data-params="map: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">getPlayers</span></span>
                            <span class="params">(<span style="color: #9cdcfe">map</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-getSession"
                         data-search="player.getSession"
                         data-implementation="{
    if (!username) return;
    username = username.toLowerCase();
    const response = (await query(
      &quot;SELECT session_id FROM accounts WHERE username = ?&quot;,
      [username]
    )) as any;
    return response[0]?.session_id;
  }"
                         data-function="player.getSession"
                         data-async="true"
                         data-params="username: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">getSession</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-getSessionId"
                         data-search="player.getSessionId"
                         data-implementation="{
    if (!token) return;
    const response = await query(
      &quot;SELECT session_id FROM accounts WHERE token = ?&quot;,
      [token]
    );
    return response;
  }"
                         data-function="player.getSessionId"
                         data-async="true"
                         data-params="token: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">getSessionId</span></span>
                            <span class="params">(<span style="color: #9cdcfe">token</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-getSessionIdByUsername"
                         data-search="player.getSessionIdByUsername"
                         data-implementation="{
    if (!username) return;
    username = username.toLowerCase();
    const response = (await query(
      &quot;SELECT session_id FROM accounts WHERE username = ?&quot;,
      [username]
    )) as any;
    return response[0]?.session_id;
  }"
                         data-function="player.getSessionIdByUsername"
                         data-async="true"
                         data-params="username: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">getSessionIdByUsername</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-getStats"
                         data-search="player.getStats"
                         data-implementation="{
    if (!username) return;
    username = username.toLowerCase();
    const response = (await query(
      &quot;SELECT max_health, health, max_stamina, stamina, xp, max_xp, level FROM stats WHERE username = ?&quot;,
      [username]
    )) as StatsData[];
    if (!response || response.length === 0) return [];
    return {
      health: response[0].health,
      max_health: response[0].max_health,
      stamina: response[0].stamina,
      max_stamina: response[0].max_stamina,
      level: response[0].level,
      xp: response[0].xp,
      max_xp: response[0].max_xp,
    };
  }"
                         data-function="player.getStats"
                         data-async="true"
                         data-params="username: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">getStats</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-getUsernameBySession"
                         data-search="player.getUsernameBySession"
                         data-implementation="{
    if (!session_id) return;
    const response = await query(
      &quot;SELECT username, id FROM accounts WHERE session_id = ?&quot;,
      [session_id]
    );
    return response;
  }"
                         data-function="player.getUsernameBySession"
                         data-async="true"
                         data-params="session_id: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">getUsernameBySession</span></span>
                            <span class="params">(<span style="color: #9cdcfe">session_id</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-getUsernameByToken"
                         data-search="player.getUsernameByToken"
                         data-implementation="{
    if (!token) return;
    const response = await query(
      &quot;SELECT username FROM accounts WHERE token = ?&quot;,
      [token]
    );
    return response;
  }"
                         data-function="player.getUsernameByToken"
                         data-async="true"
                         data-params="token: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">getUsernameByToken</span></span>
                            <span class="params">(<span style="color: #9cdcfe">token</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-increaseLevel"
                         data-search="player.increaseLevel"
                         data-implementation="{
    if (!username) return;
    username = username.toLowerCase();
    const response = await query(
      &quot;UPDATE stats SET level = level + 1 WHERE username = ?&quot;,
      [username]
    );
    return response;
  }"
                         data-function="player.increaseLevel"
                         data-async="true"
                         data-params="username: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">increaseLevel</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-increaseXp"
                         data-search="player.increaseXp"
                         data-implementation="{
    if (!username) return;
    username = username.toLowerCase();
    // Get the current xp, level and max_xp
    const stats = (await player.getStats(username)) as StatsData;
    // Loop to handle multiple level-ups
    while (xp &gt; 0) {
      const xpToLevel = stats.max_xp - stats.xp;
      if (xp &gt;= xpToLevel) {
        stats.level++;
        xp -= xpToLevel;
        stats.xp = 0;
        // Update the max_xp required to level up dynamically
        stats.max_xp = player.getNewMaxXp(stats.level);
      } else {
        stats.xp += xp;
        xp = 0;
      }
    }
    // Update the xp and level
    const response = await query(
      &quot;UPDATE stats SET xp = ?, max_xp = ?, level = ? WHERE username = ?&quot;,
      [stats.xp, stats.max_xp, stats.level, username]
    );
    if (!response) return [];
    return {
      xp: stats.xp,
      level: stats.level,
      max_xp: stats.max_xp,
    };
  }"
                         data-function="player.increaseXp"
                         data-async="true"
                         data-params="username: string, xp: number"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">increaseXp</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">xp</span>: <span style="color: #4ec9b0">number</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-isAdmin"
                         data-search="player.isAdmin"
                         data-implementation="{
    if (!username) return;
    username = username.toLowerCase();
    const response = (await query(
      &quot;SELECT role FROM accounts WHERE username = ?&quot;,
      [username]
    )) as any;
    return response[0]?.role === 1;
  }"
                         data-function="player.isAdmin"
                         data-async="true"
                         data-params="username: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">isAdmin</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-isBanned"
                         data-search="player.isBanned"
                         data-implementation="{
    if (!username) return;
    username = username.toLowerCase();
    const response = await query(
      &quot;SELECT banned FROM accounts WHERE username = ?&quot;,
      [username]
    );
    return response;
  }"
                         data-function="player.isBanned"
                         data-async="true"
                         data-params="username: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">isBanned</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-isGuest"
                         data-search="player.isGuest"
                         data-implementation="{
    if (!username) return;
    username = username.toLowerCase();
    const response = (await query(
      &quot;SELECT guest_mode FROM accounts WHERE username = ?&quot;,
      [username]
    )) as any;
    return response[0]?.guest_mode === 1;
  }"
                         data-function="player.isGuest"
                         data-async="true"
                         data-params="username: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">isGuest</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-isInPvPZone"
                         data-search="player.isInPvPZone"
                         data-implementation="{
    const playerWidth = playerProperties.width || 32;
    const playerHeight = playerProperties.height || 32;

    const mapKey = map.replace(&quot;.json&quot;, &quot;&quot;);

    // Fetch PvP tile data from Redis hash
    const pvpData = await assetCache.getNested(mapKey, &quot;nopvp&quot;);
    if (!pvpData || !Array.isArray(pvpData) || pvpData.length &lt; 3) return false;

    // Fetch map properties (can be stored as a hash or a string)
    const mapPropertiesRaw = await assetCache.get(&quot;mapProperties&quot;) as MapProperties[];
    if (!mapPropertiesRaw) return false;

    const mapData = mapPropertiesRaw.find(m =&gt; m.name.replace(&quot;.json&quot;, &quot;&quot;) === mapKey);
    if (!mapData) return false;

    const tileData = pvpData.slice(2);
    const tileWidth = mapData.tileWidth;
    const tileHeight = mapData.tileHeight;
    const gridOffsetWidth = Math.floor(mapData.width / 2);
    const gridOffsetHeight = Math.floor(mapData.height / 2);

    const margin = 0.1;
    const adjustedX = position.x + tileWidth / 2;
    const adjustedY = position.y + tileHeight / 2;

    const left = Math.floor((adjustedX + margin) / tileWidth);
    const right = Math.floor((adjustedX + playerWidth - margin) / tileWidth);
    const top = Math.floor((adjustedY + margin) / tileHeight);
    const bottom = Math.floor((adjustedY + playerHeight - margin) / tileHeight);

    for (let y = top; y &lt;= bottom; y++) {
      for (let x = left; x &lt;= right; x++) {
        const indexX = x + gridOffsetWidth;
        const indexY = y + gridOffsetHeight;
        const targetIndex = indexY * mapData.width + indexX;

        let currentIndex = 0;
        let tileValue = 0;

        for (let i = 0; i &lt; tileData.length; i += 2) {
          const value = tileData[i];
          const count = tileData[i + 1];

          if (currentIndex + count &gt; targetIndex) {
            tileValue = value;
            break;
          }
          currentIndex += count;
        }

        if (tileValue !== 0) {
          return false; // No-PvP tile → cannot attack here
        }
      }
    }

    return true; // All tiles under player are PvP-enabled
  }"
                         data-function="player.isInPvPZone"
                         data-async="true"
                         data-params="map: string, position: PositionData, playerProperties: PlayerProperties"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">isInPvPZone</span></span>
                            <span class="params">(<span style="color: #9cdcfe">map</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">position</span>: <span style="color: #4ec9b0">PositionData</span>, <span style="color: #9cdcfe">playerProperties</span>: <span style="color: #4ec9b0">PlayerProperties</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-isNoclip"
                         data-search="player.isNoclip"
                         data-implementation="{
    if (!username) return;
    username = username.toLowerCase();
    const response = (await query(
      &quot;SELECT noclip FROM accounts WHERE username = ?&quot;,
      [username]
    )) as any;
    return response[0]?.noclip === 1;
  }"
                         data-function="player.isNoclip"
                         data-async="true"
                         data-params="username: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">isNoclip</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-isOnline"
                         data-search="player.isOnline"
                         data-implementation="{
    if (!username) return;
    username = username.toLowerCase();
    const response = await query(
      &quot;SELECT online FROM accounts WHERE username = ?&quot;,
      [username]
    );
    return response;
  }"
                         data-function="player.isOnline"
                         data-async="true"
                         data-params="username: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">isOnline</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-isStealth"
                         data-search="player.isStealth"
                         data-implementation="{
    if (!username) return;
    username = username.toLowerCase();
    const response = (await query(
      &quot;SELECT stealth FROM accounts WHERE username = ?&quot;,
      [username]
    )) as any;
    return response[0]?.stealth === 1;
  }"
                         data-function="player.isStealth"
                         data-async="true"
                         data-params="username: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">isStealth</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-kick"
                         data-search="player.kick"
                         data-implementation="{
    const response = (await query(
      &quot;SELECT session_id FROM accounts WHERE username = ?&quot;,
      [username]
    )) as any;
    if (response[0]?.session_id) {
      player.logout(response[0]?.session_id);
    }
    if (ws) ws.close();
  }"
                         data-function="player.kick"
                         data-async="true"
                         data-params="username: string, ws: WebSocket"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">kick</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">ws</span>: <span style="color: #4ec9b0">WebSocket</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-login"
                         data-search="player.login"
                         data-implementation="{
    if (!username || !password) return;
    username = username.toLowerCase();
    // Validate credentials
    const response = (await query(
      &quot;SELECT username, banned, token, password_hash FROM accounts WHERE username = ?&quot;,
      [username]
    )) as {
      username: string;
      banned: number;
      token: string;
      password_hash: string;
    }[];
    if (response.length === 0 || response[0].banned === 1) {
      log.debug(`User ${username} failed to login`);
      return;
    }

    // Verify password
    const isValid = await verify(password, response[0].password_hash);
    if (!isValid) {
      log.debug(`User ${username} failed to login`);
      return;
    }

    // Use existing token and check validity or generate new one
    const token = response[0].token || (await player.setToken(username));

    log.debug(`User ${username} logged in`);
    // Update last_login
    await query(
      &quot;UPDATE accounts SET last_login = CURRENT_TIMESTAMP WHERE username = ?&quot;,
      [username]
    );
    return token;
  }"
                         data-function="player.login"
                         data-async="true"
                         data-params="username: string, password: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">login</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">password</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-logout"
                         data-search="player.logout"
                         data-implementation="{
    if (!session_id) return;
    const response = await query(
      &quot;UPDATE accounts SET token = NULL, online = ?, session_id = NULL, verification_code = NULL, verified = ? WHERE session_id = ?&quot;,
      [0, 0, session_id]
    );
    return response;
  }"
                         data-function="player.logout"
                         data-async="true"
                         data-params="session_id: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">logout</span></span>
                            <span class="params">(<span style="color: #9cdcfe">session_id</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-register"
                         data-search="player.register"
                         data-implementation="{
    if (!username || !password_hash || !email)
      return { error: &quot;Missing fields&quot; };
    username = username.toLowerCase();
    email = email.toLowerCase();

    if (!guest &amp;&amp; username.startsWith(&quot;guest_&quot;))
      return { error: &quot;Username cannot start with &#039;guest_&#039;&quot; };

    // Check if the user exists by username
    const usernameExists = (await player.findByUsername(username)) as string[];
    if (usernameExists &amp;&amp; usernameExists.length != 0)
      return { error: &quot;Username already exists&quot; };

    // Check if the user exists by email
    const emailExists = (await player.findByEmail(email)) as string[];
    if (emailExists &amp;&amp; emailExists.length != 0)
      return { error: &quot;Email already exists&quot; };

    const response = await query(
      &quot;INSERT INTO accounts (email, username, token, password_hash, ip_address, geo_location, map, position, guest_mode) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;,
      [
        email,
        username,
        &quot;&quot;, // empty token
        password_hash,
        req.ip,
        req.headers[&quot;cf-ipcountry&quot;],
        defaultMap,
        &quot;0,0&quot;,
        guest ? 1 : 0,
      ]
    ).catch((err) =&gt; {
      log.error(err);
      return { error: &quot;An unexpected error occurred&quot; };
    });
    if (!response) return { error: &quot;An unexpected error occurred&quot; };

    // Create stats
    await query(
      &quot;INSERT INTO stats (username, health, max_health, stamina, max_stamina, xp, max_xp, level) VALUES (?, ?, ?, ?, ?, ?, ?, ?)&quot;,
      [username, 100, 100, 100, 100, 0, 100, 1]
    );
    // Create client config
    await query(
      &quot;INSERT INTO clientconfig (username, fps, music_volume, effects_volume, muted) VALUES (?, ?, ?, ?, ?)&quot;,
      [username, 60, 50, 50, 0]
    );
    // Create quest log
    await query(&quot;INSERT INTO quest_log (username) VALUES (?)&quot;, [username]);
    // Create currency
    await query(
      &quot;INSERT INTO currency (username, copper, silver, gold) VALUES (?, ?, ?, ?)&quot;,
      [username, 0, 0, 0]
    );
    return username;
  }"
                         data-function="player.register"
                         data-async="true"
                         data-params="username: string, password_hash: string, email: string, req: any, guest: boolean"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">register</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">password_hash</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">email</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">req</span>: <span style="color: #4ec9b0">any</span>, <span style="color: #9cdcfe">guest</span>: <span style="color: #4ec9b0">boolean</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-returnHome"
                         data-search="player.returnHome"
                         data-implementation="{
    if (!session_id) return;
    const response = await query(
      &quot;UPDATE accounts SET map = ?, position = &#039;0,0&#039; WHERE session_id = ?&quot;,
      [defaultMap, session_id]
    );
    return response;
  }"
                         data-function="player.returnHome"
                         data-async="true"
                         data-params="session_id: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">returnHome</span></span>
                            <span class="params">(<span style="color: #9cdcfe">session_id</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-setConfig"
                         data-search="player.setConfig"
                         data-implementation="{
    if (!session_id) return;
    if (
      !data.fps ||
      typeof data.music_volume != &quot;number&quot; ||
      typeof data.effects_volume != &quot;number&quot; ||
      typeof data.muted != &quot;boolean&quot;
    )
      return [];
    const result = (await query(
      &quot;SELECT username FROM accounts WHERE session_id = ?&quot;,
      [session_id]
    )) as any;
    if (!result[0].username) return [];
    const response = await query(
      &quot;UPDATE clientconfig SET fps = ?, music_volume = ?, effects_volume = ?, muted = ? WHERE username = ?&quot;,
      [
        data.fps,
        data.music_volume || 0,
        data.effects_volume || 0,
        data.muted,
        result[0].username,
      ]
    );
    if (!response) return [];
    return response;
  }"
                         data-function="player.setConfig"
                         data-async="true"
                         data-params="session_id: string, data: any"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">setConfig</span></span>
                            <span class="params">(<span style="color: #9cdcfe">session_id</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">data</span>: <span style="color: #4ec9b0">any</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-setLocation"
                         data-search="player.setLocation"
                         data-implementation="{
    if (!session_id || !map || !position) return;
    const response = await query(
      &quot;UPDATE accounts SET map = ?, position = ?, direction = ? WHERE session_id = ?&quot;,
      [map, `${position.x},${position.y}`, position.direction, session_id]
    );
    return response;
  }"
                         data-function="player.setLocation"
                         data-async="true"
                         data-params="session_id: string, map: string, position: PositionData"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">setLocation</span></span>
                            <span class="params">(<span style="color: #9cdcfe">session_id</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">map</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">position</span>: <span style="color: #4ec9b0">PositionData</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-setSessionId"
                         data-search="player.setSessionId"
                         data-implementation="{
    if (!token || !sessionId) return false;
    const getUsername = (await player.getUsernameByToken(token)) as any[];
    const username = getUsername[0]?.username as string;
    if (!username) return false;

    const isBanned = (await player.isBanned(username)) as any[] | undefined;
    if (!isBanned) return false;

    if (isBanned[0]?.banned === 1) {
      log.debug(`User ${username} is banned`);
      await player.logout(sessionId);
      return false;
    }

    await query(
      &quot;UPDATE accounts SET session_id = ?, online = ? WHERE token = ?&quot;,
      [sessionId, 1, token]
    );

    return true;
  }"
                         data-function="player.setSessionId"
                         data-async="true"
                         data-params="token: string, sessionId: string"
                         data-return="boolean | string">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">setSessionId</span></span>
                            <span class="params">(<span style="color: #9cdcfe">token</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">sessionId</span>: <span style="color: #4ec9b0">string</span>)</span>
                            <span class="return-type">: boolean | string</span>
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-setStats"
                         data-search="player.setStats"
                         data-implementation="{
    if (!username) return;
    username = username.toLowerCase();
    if (
      !stats.health ||
      !stats.max_health ||
      !stats.stamina ||
      !stats.max_stamina
    )
      return;
    const response = await query(
      &quot;UPDATE stats SET health = ?, max_health = ?, stamina = ?, max_stamina = ? WHERE username = ?&quot;,
      [
        stats.health,
        stats.max_health,
        stats.stamina,
        stats.max_stamina,
        username,
      ]
    );
    if (!response) return [];
    return response;
  }"
                         data-function="player.setStats"
                         data-async="true"
                         data-params="username: string, stats: StatsData"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">setStats</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">stats</span>: <span style="color: #4ec9b0">StatsData</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-setToken"
                         data-search="player.setToken"
                         data-implementation="{
    const token = randomBytes(32);
    if (!username || !token) return;
    // Store the token value in the database
    const response = await query(
      &quot;UPDATE accounts SET token = ? WHERE username = ?&quot;,
      [token, username]
    );
    if (!response) return;
    // Return the hashed token for client use
    return token;
  }"
                         data-function="player.setToken"
                         data-async="true"
                         data-params="username: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">setToken</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-toggleAdmin"
                         data-search="player.toggleAdmin"
                         data-implementation="{
    if (!username) return;
    username = username.toLowerCase();
    const response = (await query(
      &quot;UPDATE accounts SET role = !role WHERE username = ?&quot;,
      [username]
    )) as any;
    if (!response) return;
    const admin = await player.isAdmin(username);
    // Remove stealth status if the player is not an admin and is stealth
    if (!admin)
      (await query(
        &quot;UPDATE accounts SET stealth = 0, noclip = 0 WHERE username = ?&quot;,
        [username]
      )) as any;
    log.debug(`${username} admin status has been updated to ${admin}`);
    return admin;
  }"
                         data-function="player.toggleAdmin"
                         data-async="true"
                         data-params="username: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">toggleAdmin</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-toggleNoclip"
                         data-search="player.toggleNoclip"
                         data-implementation="{
    if (!username) return;
    username = username.toLowerCase();
    (await query(
      &quot;UPDATE accounts SET noclip = CASE WHEN noclip = 1 THEN 0 ELSE 1 END WHERE username = ?&quot;,
      [username]
    )) as any;
    return await player.isNoclip(username);
  }"
                         data-function="player.toggleNoclip"
                         data-async="true"
                         data-params="username: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">toggleNoclip</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-toggleStealth"
                         data-search="player.toggleStealth"
                         data-implementation="{
    if (!username) return;
    username = username.toLowerCase();
    (await query(
      &quot;UPDATE accounts SET stealth = CASE WHEN stealth = 1 THEN 0 ELSE 1 END WHERE username = ? AND role = 1&quot;,
      [username]
    )) as any;
    return await player.isStealth(username);
  }"
                         data-function="player.toggleStealth"
                         data-async="true"
                         data-params="username: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">toggleStealth</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-unban"
                         data-search="player.unban"
                         data-implementation="{
    if (!username) return;
    username = username.toLowerCase();
    const response = await query(
      &quot;UPDATE accounts SET banned = 0 WHERE username = ?&quot;,
      [username]
    );
    return response;
  }"
                         data-function="player.unban"
                         data-async="true"
                         data-params="username: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">unban</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-player-verify"
                         data-search="player.verify"
                         data-implementation="{
    // Check if there is a verification code
    const response = (await query(
      &quot;SELECT verified FROM accounts WHERE session_id = ?&quot;,
      [session_id]
    )) as any[];
    // If a verification code exists, prevent the user from logging in until they verify their account
    if (response[0]?.verified) return true;
    return false;
  }"
                         data-function="player.verify"
                         data-async="true"
                         data-params="session_id: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">player.<span class="method-name">verify</span></span>
                            <span class="params">(<span style="color: #9cdcfe">session_id</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
            </div>
        </div>
    
        <div class="system-section">
            <h2 class="system-title" id="system-questlog">questlog</h2>
            <div class="functions-container">
                
                    <div class="function-item clickable"
                         id="func-questlog-completeQuest"
                         data-search="questlog.completeQuest"
                         data-implementation="{
    const quest = await quests.find(id);
    if (!quest) return;
    const questLog = await questlog.get(username);
    if (questLog.incomplete.includes(id)) {
      questLog.incomplete.splice(questLog.incomplete.indexOf(id), 1);
      questLog.completed.push(id);
      await questlog.updateQuestLog(username, questLog);
    }
  }"
                         data-function="questlog.completeQuest"
                         data-async="true"
                         data-params="username: string, id: number"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">questlog.<span class="method-name">completeQuest</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">id</span>: <span style="color: #4ec9b0">number</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-questlog-get"
                         data-search="questlog.get"
                         data-implementation="{
    const result = await query(&quot;SELECT completed_quests, incomplete_quests FROM quest_log WHERE username = ?&quot;, [username]) as any[];
    if (!result || !result[0]) {
      return { completed: [], incomplete: [] };
    }
    const completed = result[0].completed_quests ? result[0].completed_quests.split(&quot;,&quot;) : [];
    const incomplete = result[0].incomplete_quests ? result[0].incomplete_quests.split(&quot;,&quot;) : [];
    return { completed, incomplete };
  }"
                         data-function="questlog.get"
                         data-async="true"
                         data-params="username: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">questlog.<span class="method-name">get</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-questlog-startQuest"
                         data-search="questlog.startQuest"
                         data-implementation="{
    const quest = await quests.find(id);
    if (!quest) return;
    const questLog = await questlog.get(username);
    questLog.incomplete.push(id);
    await questlog.updateQuestLog(username, questLog);
  }"
                         data-function="questlog.startQuest"
                         data-async="true"
                         data-params="username: string, id: number"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">questlog.<span class="method-name">startQuest</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">id</span>: <span style="color: #4ec9b0">number</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-questlog-updateQuestLog"
                         data-search="questlog.updateQuestLog"
                         data-implementation="{
    return await query(&quot;UPDATE quest_log SET completed_quests = ?, incomplete_quests = ? WHERE username = ?&quot;, [questLog.completed.join(&quot;,&quot;), questLog.incomplete.join(&quot;,&quot;), username]);
  }"
                         data-function="questlog.updateQuestLog"
                         data-async="true"
                         data-params="username: string, questLog: any"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">questlog.<span class="method-name">updateQuestLog</span></span>
                            <span class="params">(<span style="color: #9cdcfe">username</span>: <span style="color: #4ec9b0">string</span>, <span style="color: #9cdcfe">questLog</span>: <span style="color: #4ec9b0">any</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
            </div>
        </div>
    
        <div class="system-section">
            <h2 class="system-title" id="system-quests">quests</h2>
            <div class="functions-container">
                
                    <div class="function-item clickable"
                         id="func-quests-add"
                         data-search="quests.add"
                         data-implementation="{
    if (!quest?.name || !quest?.description || !quest?.reward || !quest?.xp_gain || !quest?.required_quest || !quest?.required_level) return;
    return await query(&quot;INSERT INTO quests (name, description, reward, xp_gain, required_quest, required_level) VALUES (?, ?, ?, ?, ?, ?)&quot;, [quest.name, quest.description, quest.reward, quest.xp_gain, quest.required_quest, quest.required_level]);
  }"
                         data-function="quests.add"
                         data-async="true"
                         data-params="quest: Quest"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">quests.<span class="method-name">add</span></span>
                            <span class="params">(<span style="color: #9cdcfe">quest</span>: <span style="color: #4ec9b0">Quest</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-quests-find"
                         data-search="quests.find"
                         data-implementation="{
    if (!id) return;
    return await query(&quot;SELECT * FROM quests WHERE id = ?&quot;, [id]);
  }"
                         data-function="quests.find"
                         data-async="true"
                         data-params="id: number"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">quests.<span class="method-name">find</span></span>
                            <span class="params">(<span style="color: #9cdcfe">id</span>: <span style="color: #4ec9b0">number</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-quests-list"
                         data-search="quests.list"
                         data-implementation="{
    return await query(&quot;SELECT * FROM quests&quot;);
  }"
                         data-function="quests.list"
                         data-async="true"
                         data-params=""
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">quests.<span class="method-name">list</span></span>
                            <span class="params">()</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-quests-remove"
                         data-search="quests.remove"
                         data-implementation="{
    if (!id) return;
    return await query(&quot;DELETE FROM quests WHERE id = ?&quot;, [id]);
  }"
                         data-function="quests.remove"
                         data-async="true"
                         data-params="id: number"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">quests.<span class="method-name">remove</span></span>
                            <span class="params">(<span style="color: #9cdcfe">id</span>: <span style="color: #4ec9b0">number</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-quests-update"
                         data-search="quests.update"
                         data-implementation="{
    if (!quest?.id) return;
    const result = await query(&quot;UPDATE quests SET name = ?, description = ?, reward = ?, xp_gain = ?, required_quest = ?, required_level = ? WHERE id = ?&quot;, [quest.name, quest.description, quest.reward, quest.xp_gain, quest.required_quest, quest.required_level, quest.id]);
    if (result) {
      const quests = await assetCache.get(&quot;quests&quot;) as Quest[];
      const index = quests.findIndex((q) =&gt; q.id === quest.id);
      quests[index] = quest;
      assetCache.set(&quot;quests&quot;, quests);
    }
  }"
                         data-function="quests.update"
                         data-async="true"
                         data-params="quest: Quest"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">quests.<span class="method-name">update</span></span>
                            <span class="params">(<span style="color: #9cdcfe">quest</span>: <span style="color: #4ec9b0">Quest</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
            </div>
        </div>
    
        <div class="system-section">
            <h2 class="system-title" id="system-spells">spells</h2>
            <div class="functions-container">
                
                    <div class="function-item clickable"
                         id="func-spells-add"
                         data-search="spells.add"
                         data-implementation="{
    if (!spell?.name) return;
    return await query(
      &quot;INSERT IGNORE INTO spells (name, damage, mana, type, range, cast_time, description) VALUES (?, ?, ?, ?, ?, ?, ?)&quot;,
        [spell.name, spell.damage, spell.mana, spell.type, spell.range, spell.cast_time, spell.description]
    );
  }"
                         data-function="spells.add"
                         data-async="true"
                         data-params="spell: SpellData"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">spells.<span class="method-name">add</span></span>
                            <span class="params">(<span style="color: #9cdcfe">spell</span>: <span style="color: #4ec9b0">SpellData</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-spells-find"
                         data-search="spells.find"
                         data-implementation="{
    if (!spell?.name) return;
    const spells = await assetCache.get(&quot;spells&quot;) as SpellData[];
    return spells.find((s) =&gt; s.name === spell.name);
  }"
                         data-function="spells.find"
                         data-async="true"
                         data-params="spell: SpellData"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">spells.<span class="method-name">find</span></span>
                            <span class="params">(<span style="color: #9cdcfe">spell</span>: <span style="color: #4ec9b0">SpellData</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-spells-list"
                         data-search="spells.list"
                         data-implementation="{
    return await query(&quot;SELECT * FROM spells&quot;);
  }"
                         data-function="spells.list"
                         data-async="true"
                         data-params=""
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">spells.<span class="method-name">list</span></span>
                            <span class="params">()</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-spells-remove"
                         data-search="spells.remove"
                         data-implementation="{
    if (!spell?.name) return;
    return await query(&quot;DELETE FROM spells WHERE name = ?&quot;, [spell.name]);
  }"
                         data-function="spells.remove"
                         data-async="true"
                         data-params="spell: SpellData"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">spells.<span class="method-name">remove</span></span>
                            <span class="params">(<span style="color: #9cdcfe">spell</span>: <span style="color: #4ec9b0">SpellData</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-spells-update"
                         data-search="spells.update"
                         data-implementation="{
    if (!spell?.name) return;
    const result = await query(
        &quot;UPDATE spells SET damage = ?, mana = ?, type = ?, range = ?, cast_time = ?, description = ? WHERE name = ?&quot;,
        [spell.damage, spell.mana, spell.type, spell.range, spell.cast_time, spell.description, spell.name]
    );
    if (result) {
      const spells = await assetCache.get(&quot;spells&quot;) as SpellData[];
      const index = spells.findIndex((s) =&gt; s.name === spell.name);
      spells[index] = spell;
      assetCache.set(&quot;spells&quot;, spells);
    }
  }"
                         data-function="spells.update"
                         data-async="true"
                         data-params="spell: SpellData"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">spells.<span class="method-name">update</span></span>
                            <span class="params">(<span style="color: #9cdcfe">spell</span>: <span style="color: #4ec9b0">SpellData</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
            </div>
        </div>
    
        <div class="system-section">
            <h2 class="system-title" id="system-weapons">weapons</h2>
            <div class="functions-container">
                
                    <div class="function-item clickable"
                         id="func-weapons-add"
                         data-search="weapons.add"
                         data-implementation="{
    if (!weapon?.name) return;
    return await query(
      &quot;INSERT IGNORE INTO weapons (name, damage, mana, type, description, quality) VALUES (?, ?, ?, ?, ?, ?)&quot;,
      [weapon.name, weapon.damage, weapon.mana, weapon.type, weapon.description, weapon.quality]
    );
  }"
                         data-function="weapons.add"
                         data-async="true"
                         data-params="weapon: WeaponData"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">weapons.<span class="method-name">add</span></span>
                            <span class="params">(<span style="color: #9cdcfe">weapon</span>: <span style="color: #4ec9b0">WeaponData</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-weapons-find"
                         data-search="weapons.find"
                         data-implementation="{
    if (!weapon?.name) return;
    const weapons = await assetCache.get(&quot;weapons&quot;) as WeaponData[];
    return weapons.find((w) =&gt; w.name === weapon.name);
  }"
                         data-function="weapons.find"
                         data-async="true"
                         data-params="weapon: WeaponData"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">weapons.<span class="method-name">find</span></span>
                            <span class="params">(<span style="color: #9cdcfe">weapon</span>: <span style="color: #4ec9b0">WeaponData</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-weapons-list"
                         data-search="weapons.list"
                         data-implementation="{
    return await query(&quot;SELECT * FROM weapons&quot;);
  }"
                         data-function="weapons.list"
                         data-async="true"
                         data-params=""
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">weapons.<span class="method-name">list</span></span>
                            <span class="params">()</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-weapons-remove"
                         data-search="weapons.remove"
                         data-implementation="{
    if (!weapon?.name) return;
    return await query(&quot;DELETE FROM weapons WHERE name = ?&quot;, [weapon.name]);
  }"
                         data-function="weapons.remove"
                         data-async="true"
                         data-params="weapon: WeaponData"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">weapons.<span class="method-name">remove</span></span>
                            <span class="params">(<span style="color: #9cdcfe">weapon</span>: <span style="color: #4ec9b0">WeaponData</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-weapons-update"
                         data-search="weapons.update"
                         data-implementation="{
    if (!weapon?.name) return;
    const result = await query(
      &quot;UPDATE weapons SET damage = ?, mana = ?, type = ?, description = ?, quality = ? WHERE name = ?&quot;,
      [weapon.damage, weapon.mana, weapon.type, weapon.description, weapon.quality, weapon.name]
    );
    if (result) {
      const weapons = await assetCache.get(&quot;weapons&quot;) as WeaponData[];
      const index = weapons.findIndex((w) =&gt; w.name === weapon.name);
      weapons[index] = weapon;
      assetCache.set(&quot;weapons&quot;, weapons);
    }
  }"
                         data-function="weapons.update"
                         data-async="true"
                         data-params="weapon: WeaponData"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">weapons.<span class="method-name">update</span></span>
                            <span class="params">(<span style="color: #9cdcfe">weapon</span>: <span style="color: #4ec9b0">WeaponData</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
            </div>
        </div>
    
        <div class="system-section">
            <h2 class="system-title" id="system-weather">weather</h2>
            <div class="functions-container">
                
                    <div class="function-item clickable"
                         id="func-weather-add"
                         data-search="weather.add"
                         data-implementation="{
    if (!weather?.name) return;
    const response = await query(&quot;INSERT INTO weather (name, temperature, humidity, wind_speed, wind_direction, precipitation, ambience) VALUES (?, ?, ?, ?, ?, ?, ?)&quot;, [weather.name, weather.temperature, weather.humidity, weather.wind_speed, weather.wind_direction, weather.precipitation, weather.ambience]);
    assetCache.set(&quot;weather&quot;, response);
    return response;
  }"
                         data-function="weather.add"
                         data-async="true"
                         data-params="weather: WeatherData"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">weather.<span class="method-name">add</span></span>
                            <span class="params">(<span style="color: #9cdcfe">weather</span>: <span style="color: #4ec9b0">WeatherData</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-weather-find"
                         data-search="weather.find"
                         data-implementation="{
    if (!weather?.name) return;
    const weathers = await assetCache.get(&quot;weather&quot;) as WeatherData[];
    return weathers.find((w) =&gt; w.name === weather.name);
  }"
                         data-function="weather.find"
                         data-async="true"
                         data-params="weather: WeatherData"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">weather.<span class="method-name">find</span></span>
                            <span class="params">(<span style="color: #9cdcfe">weather</span>: <span style="color: #4ec9b0">WeatherData</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-weather-list"
                         data-search="weather.list"
                         data-implementation="{
    return await query(&quot;SELECT * FROM weather&quot;);
  }"
                         data-function="weather.list"
                         data-async="true"
                         data-params=""
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">weather.<span class="method-name">list</span></span>
                            <span class="params">()</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-weather-remove"
                         data-search="weather.remove"
                         data-implementation="{
    if (!weather?.name) return;
    const response = await query(&quot;DELETE FROM weather WHERE name = ?&quot;, [weather.name]);
    assetCache.set(&quot;weather&quot;, response);
    return response;
  }"
                         data-function="weather.remove"
                         data-async="true"
                         data-params="weather: WeatherData"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">weather.<span class="method-name">remove</span></span>
                            <span class="params">(<span style="color: #9cdcfe">weather</span>: <span style="color: #4ec9b0">WeatherData</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-weather-update"
                         data-search="weather.update"
                         data-implementation="{
    if (!weather?.name) return;
    const response = await query(&quot;UPDATE weather SET temperature = ?, humidity = ?, wind_speed = ?, wind_direction = ?, precipitation = ?, ambience = ? WHERE name = ?&quot;, [weather.temperature, weather.humidity, weather.wind_speed, weather.wind_direction, weather.precipitation, weather.ambience, weather.name]);
    assetCache.set(&quot;weather&quot;, response);
    return response;
  }"
                         data-function="weather.update"
                         data-async="true"
                         data-params="weather: WeatherData"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">weather.<span class="method-name">update</span></span>
                            <span class="params">(<span style="color: #9cdcfe">weather</span>: <span style="color: #4ec9b0">WeatherData</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
            </div>
        </div>
    
        <div class="system-section">
            <h2 class="system-title" id="system-worlds">worlds</h2>
            <div class="functions-container">
                
                    <div class="function-item clickable"
                         id="func-worlds-add"
                         data-search="worlds.add"
                         data-implementation="{
    await query(&quot;INSERT INTO worlds (name, weather, max_players, default_map) VALUES (?, ?, ?, ?)&quot;, [world.name, world.weather, world.max_players, world.default_map]);
  }"
                         data-function="worlds.add"
                         data-async="true"
                         data-params="world: WorldData"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">worlds.<span class="method-name">add</span></span>
                            <span class="params">(<span style="color: #9cdcfe">world</span>: <span style="color: #4ec9b0">WorldData</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-worlds-get"
                         data-search="worlds.get"
                         data-implementation="{
    const worlds = await assetCache.get(&quot;worlds&quot;) as WorldData[];
    return worlds.find((w) =&gt; w.name === world);
  }"
                         data-function="worlds.get"
                         data-async="true"
                         data-params="world: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">worlds.<span class="method-name">get</span></span>
                            <span class="params">(<span style="color: #9cdcfe">world</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-worlds-getCurrentWeather"
                         data-search="worlds.getCurrentWeather"
                         data-implementation="{
    const worldData = await this.get(world);
    return worldData?.weather || &quot;clear&quot;;
  }"
                         data-function="worlds.getCurrentWeather"
                         data-async="true"
                         data-params="world: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">worlds.<span class="method-name">getCurrentWeather</span></span>
                            <span class="params">(<span style="color: #9cdcfe">world</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-worlds-getMaxPlayers"
                         data-search="worlds.getMaxPlayers"
                         data-implementation="{
    const worldData = await this.get(world);
    return worldData?.max_players || 100;
  }"
                         data-function="worlds.getMaxPlayers"
                         data-async="true"
                         data-params="world: string"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">worlds.<span class="method-name">getMaxPlayers</span></span>
                            <span class="params">(<span style="color: #9cdcfe">world</span>: <span style="color: #4ec9b0">string</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-worlds-list"
                         data-search="worlds.list"
                         data-implementation="{
    const results = await query(&quot;SELECT * FROM worlds&quot;) as WorldData[];
    const worlds = results.map(world =&gt; {
      const players = 0;
      return { ...world, players };
    });
    return worlds;
  }"
                         data-function="worlds.list"
                         data-async="true"
                         data-params=""
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">worlds.<span class="method-name">list</span></span>
                            <span class="params">()</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-worlds-remove"
                         data-search="worlds.remove"
                         data-implementation="{
    await query(&quot;DELETE FROM worlds WHERE name = ?&quot;, [world.name]);
  }"
                         data-function="worlds.remove"
                         data-async="true"
                         data-params="world: WorldData"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">worlds.<span class="method-name">remove</span></span>
                            <span class="params">(<span style="color: #9cdcfe">world</span>: <span style="color: #4ec9b0">WorldData</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
                    <div class="function-item clickable"
                         id="func-worlds-update"
                         data-search="worlds.update"
                         data-implementation="{
    await query(&quot;UPDATE worlds SET name = ?, weather = ?, max_players = ?, default_map = ? WHERE name = ?&quot;, [world.name, world.weather, world.max_players, world.default_map, world.name]);
  }"
                         data-function="worlds.update"
                         data-async="true"
                         data-params="world: WorldData"
                         data-return="">
                        <div class="function-signature">
                            <span class="async-badge">async</span>
                            <span class="function-name">worlds.<span class="method-name">update</span></span>
                            <span class="params">(<span style="color: #9cdcfe">world</span>: <span style="color: #4ec9b0">WorldData</span>)</span>
                            
                            <span class="view-code-hint">👁️ Click to view code</span>
                        </div>
                    </div>
                
            </div>
        </div>
    
        <div class="stats">
            <p>Total Systems: 17 | Total Functions: 128</p>
            <p>Generated on 10/28/2025, 11:22:34 PM</p>
        </div>
    </div>

    <!-- Code Modal -->
    <div class="modal" id="codeModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle"></div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="code-block" id="codeBlock"></div>
                <button class="copy-button" id="copyButton" onclick="copyCode()">Copy Code</button>
            </div>
        </div>
    </div>

    <script>
        // Search index
        const searchIndex = [{"system":"audio","function":"get","fullName":"audio.get","params":"name: string","async":true,"returnType":""},{"system":"audio","function":"list","fullName":"audio.list","params":"","async":true,"returnType":""},{"system":"currency","function":"add","fullName":"currency.add","params":"username: string, amount: Currency","async":true,"returnType":"Currency"},{"system":"currency","function":"get","fullName":"currency.get","params":"username: string","async":true,"returnType":"Currency"},{"system":"currency","function":"remove","fullName":"currency.remove","params":"username: string, amount: Currency","async":true,"returnType":"Currency"},{"system":"currency","function":"set","fullName":"currency.set","params":"username: string, currencyData: Currency","async":true,"returnType":""},{"system":"friends","function":"add","fullName":"friends.add","params":"username: string, friend_username: string","async":true,"returnType":""},{"system":"friends","function":"list","fullName":"friends.list","params":"username: string","async":true,"returnType":""},{"system":"friends","function":"remove","fullName":"friends.remove","params":"username: string, friend_username: string","async":true,"returnType":""},{"system":"inventory","function":"add","fullName":"inventory.add","params":"name: string, item: InventoryItem","async":true,"returnType":""},{"system":"inventory","function":"delete","fullName":"inventory.delete","params":"name: string, item: InventoryItem","async":true,"returnType":""},{"system":"inventory","function":"find","fullName":"inventory.find","params":"name: string, item: InventoryItem","async":true,"returnType":""},{"system":"inventory","function":"get","fullName":"inventory.get","params":"name: string","async":true,"returnType":""},{"system":"inventory","function":"remove","fullName":"inventory.remove","params":"name: string, item: InventoryItem","async":true,"returnType":""},{"system":"items","function":"add","fullName":"items.add","params":"item: Item","async":true,"returnType":""},{"system":"items","function":"find","fullName":"items.find","params":"item: Item","async":true,"returnType":""},{"system":"items","function":"list","fullName":"items.list","params":"","async":true,"returnType":""},{"system":"items","function":"remove","fullName":"items.remove","params":"item: Item","async":true,"returnType":""},{"system":"items","function":"update","fullName":"items.update","params":"item: Item","async":true,"returnType":""},{"system":"language","function":"translate","fullName":"language.translate","params":"text: string, lang: string","async":true,"returnType":""},{"system":"language","function":"translate_google","fullName":"language.translate_google","params":"data: any","async":true,"returnType":""},{"system":"language","function":"translate_openai","fullName":"language.translate_openai","params":"data: any","async":true,"returnType":""},{"system":"npcs","function":"add","fullName":"npcs.add","params":"npc: Npc","async":true,"returnType":""},{"system":"npcs","function":"find","fullName":"npcs.find","params":"npc: Npc","async":true,"returnType":""},{"system":"npcs","function":"list","fullName":"npcs.list","params":"","async":true,"returnType":""},{"system":"npcs","function":"move","fullName":"npcs.move","params":"npc: Npc","async":true,"returnType":""},{"system":"npcs","function":"remove","fullName":"npcs.remove","params":"npc: Npc","async":true,"returnType":""},{"system":"npcs","function":"update","fullName":"npcs.update","params":"npc: Npc","async":true,"returnType":""},{"system":"particles","function":"add","fullName":"particles.add","params":"particle: Particle","async":true,"returnType":""},{"system":"particles","function":"find","fullName":"particles.find","params":"particle: Particle","async":true,"returnType":""},{"system":"particles","function":"list","fullName":"particles.list","params":"","async":true,"returnType":""},{"system":"particles","function":"remove","fullName":"particles.remove","params":"particle: Particle","async":true,"returnType":""},{"system":"particles","function":"update","fullName":"particles.update","params":"particle: Particle","async":true,"returnType":""},{"system":"parties","function":"add","fullName":"parties.add","params":"username: string, partyId: number","async":true,"returnType":"string[]"},{"system":"parties","function":"create","fullName":"parties.create","params":"leader: string, username: string","async":true,"returnType":"string[] | boolean"},{"system":"parties","function":"delete","fullName":"parties.delete","params":"partyId: number","async":true,"returnType":"boolean"},{"system":"parties","function":"disband","fullName":"parties.disband","params":"username: string","async":true,"returnType":"boolean"},{"system":"parties","function":"exists","fullName":"parties.exists","params":"username: string","async":true,"returnType":"boolean"},{"system":"parties","function":"getPartyId","fullName":"parties.getPartyId","params":"username: string","async":true,"returnType":"number | null"},{"system":"parties","function":"getPartyLeader","fullName":"parties.getPartyLeader","params":"partyId: number","async":true,"returnType":"string | null"},{"system":"parties","function":"getPartyMembers","fullName":"parties.getPartyMembers","params":"partyId: number","async":true,"returnType":"string[]"},{"system":"parties","function":"isInParty","fullName":"parties.isInParty","params":"username: string","async":true,"returnType":"boolean"},{"system":"parties","function":"isPartyLeader","fullName":"parties.isPartyLeader","params":"username: string","async":true,"returnType":"boolean"},{"system":"parties","function":"leave","fullName":"parties.leave","params":"username: string","async":true,"returnType":"boolean | string[]"},{"system":"parties","function":"remove","fullName":"parties.remove","params":"username: string","async":true,"returnType":"string[] | boolean"},{"system":"permissions","function":"add","fullName":"permissions.add","params":"username: string, permission: string","async":true,"returnType":""},{"system":"permissions","function":"clear","fullName":"permissions.clear","params":"username: string","async":true,"returnType":""},{"system":"permissions","function":"get","fullName":"permissions.get","params":"username: string","async":true,"returnType":""},{"system":"permissions","function":"remove","fullName":"permissions.remove","params":"username: string, permission: string","async":true,"returnType":""},{"system":"permissions","function":"set","fullName":"permissions.set","params":"username: string, permissions: string | string[]","async":true,"returnType":""},{"system":"player","function":"ban","fullName":"player.ban","params":"username: string, ws: WebSocket","async":true,"returnType":""},{"system":"player","function":"canAttack","fullName":"player.canAttack","params":"self: Player, target: Player, playerProperties: PlayerProperties","async":false,"returnType":""},{"system":"player","function":"checkIfWouldCollide","fullName":"player.checkIfWouldCollide","params":"map: string, position: PositionData, playerProperties: PlayerProperties, mapPropertiesCache?: any","async":true,"returnType":""},{"system":"player","function":"clear","fullName":"player.clear","params":"","async":true,"returnType":""},{"system":"player","function":"clearSessionId","fullName":"player.clearSessionId","params":"session_id: string","async":true,"returnType":""},{"system":"player","function":"findByEmail","fullName":"player.findByEmail","params":"email: string","async":true,"returnType":""},{"system":"player","function":"findByUsername","fullName":"player.findByUsername","params":"username: string","async":true,"returnType":""},{"system":"player","function":"findClosestPlayer","fullName":"player.findClosestPlayer","params":"self: Player, players: Player[], range: number","async":false,"returnType":"NullablePlayer"},{"system":"player","function":"findPlayerInDatabase","fullName":"player.findPlayerInDatabase","params":"username?: string, id?: string","async":true,"returnType":""},{"system":"player","function":"getConfig","fullName":"player.getConfig","params":"username: string","async":true,"returnType":""},{"system":"player","function":"getEmail","fullName":"player.getEmail","params":"username: string","async":true,"returnType":""},{"system":"player","function":"getLocation","fullName":"player.getLocation","params":"player: Player","async":true,"returnType":""},{"system":"player","function":"getMap","fullName":"player.getMap","params":"session_id: string","async":true,"returnType":""},{"system":"player","function":"getNewMaxXp","fullName":"player.getNewMaxXp","params":"level: number","async":false,"returnType":""},{"system":"player","function":"getPartyIdByUsername","fullName":"player.getPartyIdByUsername","params":"username: string","async":true,"returnType":""},{"system":"player","function":"GetPlayerLoginData","fullName":"player.GetPlayerLoginData","params":"username: string","async":true,"returnType":""},{"system":"player","function":"getPlayers","fullName":"player.getPlayers","params":"map: string","async":true,"returnType":""},{"system":"player","function":"getSession","fullName":"player.getSession","params":"username: string","async":true,"returnType":""},{"system":"player","function":"getSessionId","fullName":"player.getSessionId","params":"token: string","async":true,"returnType":""},{"system":"player","function":"getSessionIdByUsername","fullName":"player.getSessionIdByUsername","params":"username: string","async":true,"returnType":""},{"system":"player","function":"getStats","fullName":"player.getStats","params":"username: string","async":true,"returnType":""},{"system":"player","function":"getUsernameBySession","fullName":"player.getUsernameBySession","params":"session_id: string","async":true,"returnType":""},{"system":"player","function":"getUsernameByToken","fullName":"player.getUsernameByToken","params":"token: string","async":true,"returnType":""},{"system":"player","function":"increaseLevel","fullName":"player.increaseLevel","params":"username: string","async":true,"returnType":""},{"system":"player","function":"increaseXp","fullName":"player.increaseXp","params":"username: string, xp: number","async":true,"returnType":""},{"system":"player","function":"isAdmin","fullName":"player.isAdmin","params":"username: string","async":true,"returnType":""},{"system":"player","function":"isBanned","fullName":"player.isBanned","params":"username: string","async":true,"returnType":""},{"system":"player","function":"isGuest","fullName":"player.isGuest","params":"username: string","async":true,"returnType":""},{"system":"player","function":"isInPvPZone","fullName":"player.isInPvPZone","params":"map: string, position: PositionData, playerProperties: PlayerProperties","async":true,"returnType":""},{"system":"player","function":"isNoclip","fullName":"player.isNoclip","params":"username: string","async":true,"returnType":""},{"system":"player","function":"isOnline","fullName":"player.isOnline","params":"username: string","async":true,"returnType":""},{"system":"player","function":"isStealth","fullName":"player.isStealth","params":"username: string","async":true,"returnType":""},{"system":"player","function":"kick","fullName":"player.kick","params":"username: string, ws: WebSocket","async":true,"returnType":""},{"system":"player","function":"login","fullName":"player.login","params":"username: string, password: string","async":true,"returnType":""},{"system":"player","function":"logout","fullName":"player.logout","params":"session_id: string","async":true,"returnType":""},{"system":"player","function":"register","fullName":"player.register","params":"username: string, password_hash: string, email: string, req: any, guest: boolean","async":true,"returnType":""},{"system":"player","function":"returnHome","fullName":"player.returnHome","params":"session_id: string","async":true,"returnType":""},{"system":"player","function":"setConfig","fullName":"player.setConfig","params":"session_id: string, data: any","async":true,"returnType":""},{"system":"player","function":"setLocation","fullName":"player.setLocation","params":"session_id: string, map: string, position: PositionData","async":true,"returnType":""},{"system":"player","function":"setSessionId","fullName":"player.setSessionId","params":"token: string, sessionId: string","async":true,"returnType":"boolean | string"},{"system":"player","function":"setStats","fullName":"player.setStats","params":"username: string, stats: StatsData","async":true,"returnType":""},{"system":"player","function":"setToken","fullName":"player.setToken","params":"username: string","async":true,"returnType":""},{"system":"player","function":"toggleAdmin","fullName":"player.toggleAdmin","params":"username: string","async":true,"returnType":""},{"system":"player","function":"toggleNoclip","fullName":"player.toggleNoclip","params":"username: string","async":true,"returnType":""},{"system":"player","function":"toggleStealth","fullName":"player.toggleStealth","params":"username: string","async":true,"returnType":""},{"system":"player","function":"unban","fullName":"player.unban","params":"username: string","async":true,"returnType":""},{"system":"player","function":"verify","fullName":"player.verify","params":"session_id: string","async":true,"returnType":""},{"system":"questlog","function":"completeQuest","fullName":"questlog.completeQuest","params":"username: string, id: number","async":true,"returnType":""},{"system":"questlog","function":"get","fullName":"questlog.get","params":"username: string","async":true,"returnType":""},{"system":"questlog","function":"startQuest","fullName":"questlog.startQuest","params":"username: string, id: number","async":true,"returnType":""},{"system":"questlog","function":"updateQuestLog","fullName":"questlog.updateQuestLog","params":"username: string, questLog: any","async":true,"returnType":""},{"system":"quests","function":"add","fullName":"quests.add","params":"quest: Quest","async":true,"returnType":""},{"system":"quests","function":"find","fullName":"quests.find","params":"id: number","async":true,"returnType":""},{"system":"quests","function":"list","fullName":"quests.list","params":"","async":true,"returnType":""},{"system":"quests","function":"remove","fullName":"quests.remove","params":"id: number","async":true,"returnType":""},{"system":"quests","function":"update","fullName":"quests.update","params":"quest: Quest","async":true,"returnType":""},{"system":"spells","function":"add","fullName":"spells.add","params":"spell: SpellData","async":true,"returnType":""},{"system":"spells","function":"find","fullName":"spells.find","params":"spell: SpellData","async":true,"returnType":""},{"system":"spells","function":"list","fullName":"spells.list","params":"","async":true,"returnType":""},{"system":"spells","function":"remove","fullName":"spells.remove","params":"spell: SpellData","async":true,"returnType":""},{"system":"spells","function":"update","fullName":"spells.update","params":"spell: SpellData","async":true,"returnType":""},{"system":"weapons","function":"add","fullName":"weapons.add","params":"weapon: WeaponData","async":true,"returnType":""},{"system":"weapons","function":"find","fullName":"weapons.find","params":"weapon: WeaponData","async":true,"returnType":""},{"system":"weapons","function":"list","fullName":"weapons.list","params":"","async":true,"returnType":""},{"system":"weapons","function":"remove","fullName":"weapons.remove","params":"weapon: WeaponData","async":true,"returnType":""},{"system":"weapons","function":"update","fullName":"weapons.update","params":"weapon: WeaponData","async":true,"returnType":""},{"system":"weather","function":"add","fullName":"weather.add","params":"weather: WeatherData","async":true,"returnType":""},{"system":"weather","function":"find","fullName":"weather.find","params":"weather: WeatherData","async":true,"returnType":""},{"system":"weather","function":"list","fullName":"weather.list","params":"","async":true,"returnType":""},{"system":"weather","function":"remove","fullName":"weather.remove","params":"weather: WeatherData","async":true,"returnType":""},{"system":"weather","function":"update","fullName":"weather.update","params":"weather: WeatherData","async":true,"returnType":""},{"system":"worlds","function":"add","fullName":"worlds.add","params":"world: WorldData","async":true,"returnType":""},{"system":"worlds","function":"get","fullName":"worlds.get","params":"world: string","async":true,"returnType":""},{"system":"worlds","function":"getCurrentWeather","fullName":"worlds.getCurrentWeather","params":"world: string","async":true,"returnType":""},{"system":"worlds","function":"getMaxPlayers","fullName":"worlds.getMaxPlayers","params":"world: string","async":true,"returnType":""},{"system":"worlds","function":"list","fullName":"worlds.list","params":"","async":true,"returnType":""},{"system":"worlds","function":"remove","fullName":"worlds.remove","params":"world: WorldData","async":true,"returnType":""},{"system":"worlds","function":"update","fullName":"worlds.update","params":"world: WorldData","async":true,"returnType":""}];

        // Modal Elements and Functions (defined first so they're available to other handlers)
        const modal = document.getElementById('codeModal');
        const modalTitle = document.getElementById('modalTitle');
        const codeBlock = document.getElementById('codeBlock');
        const copyButton = document.getElementById('copyButton');
        let currentCode = '';

        // Decode HTML entities
        function decodeHtml(html) {
            const txt = document.createElement('textarea');
            txt.innerHTML = html;
            return txt.value;
        }

        function openModal(functionName, implementation, isAsync, params, returnType) {
            // Clean any inline comments from params and normalize whitespace
            const cleanParams = params
                .replace(/\/\/.*$/gm, '')  // Remove // comments
                .replace(/\/\*.*?\*\//g, '')  // Remove /* */ comments
                .replace(/\s+/g, ' ')  // Normalize whitespace
                .trim();

            // Build function signature
            const signature = `${isAsync === 'true' ? 'async ' : ''}${functionName}(${cleanParams})${returnType ? ': ' + returnType : ''}`;
            modalTitle.textContent = signature;

            // Decode HTML entities from the data attribute
            const decodedCode = decodeHtml(implementation);

            // Store current code for copying
            currentCode = decodedCode;

            // Escape HTML entities for display, then apply syntax highlighting
            const escapedCode = decodedCode
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            // Apply basic syntax highlighting
            const highlighted = syntaxHighlight(escapedCode);
            codeBlock.innerHTML = '<pre>' + highlighted + '</pre>';

            // Show modal
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            modal.classList.remove('active');
            document.body.style.overflow = '';
            copyButton.textContent = 'Copy Code';
            copyButton.classList.remove('copied');
        }

        function copyCode() {
            navigator.clipboard.writeText(currentCode).then(() => {
                copyButton.textContent = '✓ Copied!';
                copyButton.classList.add('copied');
                setTimeout(() => {
                    copyButton.textContent = 'Copy Code';
                    copyButton.classList.remove('copied');
                }, 2000);
            });
        }

        // Basic syntax highlighting - works on HTML-escaped code
        function syntaxHighlight(code) {
            return code
                // Keywords
                .replace(/\b(async|await|const|let|var|function|return|if|else|for|while|switch|case|break|continue|try|catch|finally|throw|new|class|extends|import|export|default|from|as|typeof|instanceof|Promise)\b/g, '<span style="color: #569cd6">$1</span>')
                // Strings (handle quotes)
                .replace(/(&quot;)((?:(?!&quot;).)*?)(&quot;)/g, '<span style="color: #ce9178">$1$2$3</span>')
                .replace(/(&#039;)((?:(?!&#039;).)*?)(&#039;)/g, '<span style="color: #ce9178">$1$2$3</span>')
                .replace(/(`)((?:(?!`).)*?)(`)/g, '<span style="color: #ce9178">$1$2$3</span>')
                // Comments
                .replace(/(\/\/.*$)/gm, '<span style="color: #6a9955">$1</span>')
                .replace(/(\/\*[\s\S]*?\*\/)/g, '<span style="color: #6a9955">$1</span>')
                // Numbers
                .replace(/\b(\d+)\b/g, '<span style="color: #b5cea8">$1</span>')
                // this, null, undefined, true, false
                .replace(/\b(this|null|undefined|true|false)\b/g, '<span style="color: #569cd6">$1</span>')
                // Function calls (before the opening paren)
                .replace(/\b([a-zA-Z_$][a-zA-Z0-9_$]*)(?=\s*\()/g, '<span style="color: #dcdcaa">$1</span>');
        }

        // Search Elements
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        let selectedIndex = -1;

        // Search functionality
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim().toLowerCase();

            if (query.length === 0) {
                searchResults.classList.remove('active');
                searchResults.innerHTML = '';
                selectedIndex = -1;
                return;
            }

            // Find matching functions
            const matches = searchIndex.filter(item => {
                const fullName = item.fullName.toLowerCase();
                const funcName = item.function.toLowerCase();
                const systemName = item.system.toLowerCase();

                return fullName.includes(query) ||
                       funcName.includes(query) ||
                       systemName.includes(query);
            }).slice(0, 10); // Limit to 10 results

            if (matches.length === 0) {
                searchResults.innerHTML = '<div class="search-no-results">No functions found</div>';
                searchResults.classList.add('active');
                return;
            }

            // Render results
            searchResults.innerHTML = matches.map((item, index) => `
                <div class="search-result-item" data-index="${index}" data-id="func-${item.system}-${item.function}">
                    <div class="search-result-name">
                        <span class="search-result-method">${item.fullName}</span>
                        ${item.async ? '<span class="async-badge" style="margin-left: 8px;">async</span>' : ''}
                    </div>
                    <div class="search-result-params">(${item.params})${item.returnType ? ': ' + item.returnType : ''}</div>
                </div>
            `).join('');

            searchResults.classList.add('active');
            selectedIndex = -1;
        });

        // Keyboard navigation
        searchInput.addEventListener('keydown', (e) => {
            const items = searchResults.querySelectorAll('.search-result-item');

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                updateSelection(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateSelection(items);
            } else if (e.key === 'Enter' && selectedIndex >= 0) {
                e.preventDefault();
                items[selectedIndex]?.click();
            } else if (e.key === 'Escape') {
                searchResults.classList.remove('active');
                selectedIndex = -1;
            }
        });

        function updateSelection(items) {
            items.forEach((item, index) => {
                if (index === selectedIndex) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        // Handle result click
        searchResults.addEventListener('click', (e) => {
            const item = e.target.closest('.search-result-item');
            if (item) {
                const targetId = item.getAttribute('data-id');
                const targetElement = document.getElementById(targetId);

                if (targetElement) {
                    // Expand the parent section
                    const parentSection = targetElement.closest('.system-section');
                    if (parentSection) {
                        parentSection.classList.remove('collapsed');
                    }

                    // Smooth scroll to element
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    // Highlight the element briefly
                    targetElement.style.transform = 'scale(1.02)';
                    targetElement.style.transition = 'transform 0.3s ease';

                    setTimeout(() => {
                        targetElement.style.transform = '';
                    }, 600);

                    // Close search results
                    searchResults.classList.remove('active');
                    searchInput.value = '';
                    selectedIndex = -1;

                    // Auto-open the code modal after a brief delay for scroll animation
                    setTimeout(() => {
                        const implementation = targetElement.getAttribute('data-implementation');
                        const functionName = targetElement.getAttribute('data-function');
                        const isAsync = targetElement.getAttribute('data-async');
                        const params = targetElement.getAttribute('data-params');
                        const returnType = targetElement.getAttribute('data-return');

                        if (implementation && functionName) {
                            openModal(functionName, implementation, isAsync, params, returnType);
                        }
                    }, 400);
                }
            }
        });

        // Close search results when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-container')) {
                searchResults.classList.remove('active');
                selectedIndex = -1;
            }
        });

        // Focus search with Ctrl+K or Cmd+K
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                searchInput.focus();
            }
        });

        // Add click handlers to all function items
        document.querySelectorAll('.function-item.clickable').forEach(item => {
            item.addEventListener('click', () => {
                const implementation = item.getAttribute('data-implementation');
                const functionName = item.getAttribute('data-function');
                const isAsync = item.getAttribute('data-async');
                const params = item.getAttribute('data-params');
                const returnType = item.getAttribute('data-return');

                openModal(functionName, implementation, isAsync, params, returnType);
            });
        });

        // Close modal on outside click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.classList.contains('active')) {
                closeModal();
            }
        });

        // Collapse/Expand functionality
        document.querySelectorAll('.system-title').forEach(title => {
            title.addEventListener('click', (e) => {
                // Don't toggle if clicking on a link or other interactive element
                if (e.target.tagName === 'A') return;

                const section = title.closest('.system-section');
                section.classList.toggle('collapsed');
            });
        });

        // Set all sections to collapsed by default
        document.querySelectorAll('.system-section').forEach(section => {
            section.classList.add('collapsed');
        });
    </script>
</body>
</html>